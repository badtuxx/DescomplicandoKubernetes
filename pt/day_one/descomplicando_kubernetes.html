
<!DOCTYPE HTML>
<html lang="pt" >
    <head>
        <meta charset="UTF-8">
        <title>Descomplicando Kubernetes dia 1 ¬∑ HonKit</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 3.6.20">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../day_two/descomplicando_kubernetes.html" />
    
    
    <link rel="prev" href="../" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Escreva para pesquisar" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Sobre</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introdu√ß√£o
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Cap√≠tulos</li>
        
        
    
        <li class="chapter active" data-level="2.1" data-path="descomplicando_kubernetes.html">
            
                <a href="descomplicando_kubernetes.html">
            
                    
                    Descomplicando Kubernetes dia 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../day_two/descomplicando_kubernetes.html">
            
                <a href="../day_two/descomplicando_kubernetes.html">
            
                    
                    Descomplicando Kubernetes dia 2
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../day_three/descomplicando_kubernetes.html">
            
                <a href="../day_three/descomplicando_kubernetes.html">
            
                    
                    Descomplicando Kubernetes dia 3
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../day_four/descomplicando_kubernetes.html">
            
                <a href="../day_four/descomplicando_kubernetes.html">
            
                    
                    Descomplicando Kubernetes dia 4
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="../day_five/descomplicando_kubernetes.html">
            
                <a href="../day_five/descomplicando_kubernetes.html">
            
                    
                    Descomplicando Kubernetes dia 5
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="../day_six/descomplicando_kubernetes.html">
            
                <a href="../day_six/descomplicando_kubernetes.html">
            
                    
                    Descomplicando Kubernetes dia 6
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Extras</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../extras/cloud-providers/cloud-providers.html">
            
                <a href="../extras/cloud-providers/cloud-providers.html">
            
                    
                    Cloud providers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../extras/exame_tips.html">
            
                <a href="../extras/exame_tips.html">
            
                    
                    Dicas para o exame
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../extras/pod_security_policy.html">
            
                <a href="../extras/pod_security_policy.html">
            
                    
                    Pod security policy
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Contribuir</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../CONTRIBUTING.html">
            
                <a href="../CONTRIBUTING.html">
            
                    
                    Como ajudar
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Publicado com HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Descomplicando Kubernetes dia 1</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="descomplicando-kubernetes-dia-1">Descomplicando Kubernetes dia 1</h1>
<h2 id="sum√°rio">Sum√°rio</h2>
<ul>
<li><a href="#o-qu√™-preciso-saber-antes-de-come√ßar">O qu√™ preciso saber antes de come√ßar?</a><ul>
<li><a href="#qual-distro-gnulinux-devo-usar">Qual distro GNU/Linux devo usar?</a></li>
<li><a href="#alguns-sites-que-devemos-visitar">Alguns sites que devemos visitar</a></li>
<li><a href="#e-o-k8s">E o k8s?</a></li>
<li><a href="#arquitetura-do-k8s">Arquitetura do k8s</a></li>
<li><a href="#portas-que-devemos-nos-preocupar">Portas que devemos nos preocupar</a></li>
<li><a href="#t√°-mas-qual-tipo-de-aplica√ß√£o-eu-devo-rodar-sobre-o-k8s">T√°, mas qual tipo de aplica√ß√£o eu devo rodar sobre o k8s?</a></li>
<li><a href="#conceitos-chave-do-k8s">Conceitos-chave do k8s</a></li>
</ul>
</li>
<li><a href="#aviso-sobre-os-comandos">Aviso sobre os comandos</a></li>
<li><a href="#minikube">Minikube</a><ul>
<li><a href="#requisitos-b√°sicos">Requisitos b√°sicos</a></li>
<li><a href="#instala√ß√£o-do-minikube-no-gnulinux">Instala√ß√£o do Minikube no GNU/Linux</a></li>
<li><a href="#instala√ß√£o-do-minikube-no-macos">Instala√ß√£o do Minikube no MacOS</a></li>
<li><a href="#kubectl-alias-e-autocomplete">kubectl: alias e autocomplete</a></li>
<li><a href="#instala√ß√£o-do-minikube-no-microsoft-windows">Instala√ß√£o do Minikube no Microsoft Windows</a></li>
<li><a href="#iniciando-parando-e-excluindo-o-minikube">Iniciando, parando e excluindo o Minikube</a></li>
<li><a href="#certo-e-como-eu-sei-que-est√°-tudo-funcionando-como-deveria">Certo, e como eu sei que est√° tudo funcionando como deveria?</a></li>
<li><a href="#descobrindo-o-endere√ßo-do-minikube">Descobrindo o endere√ßo do Minikube</a></li>
<li><a href="#acessando-a-m√°quina-do-minikube-via-ssh">Acessando a m√°quina do Minikube via SSH</a></li>
<li><a href="#dashboard">Dashboard</a></li>
<li><a href="#logs">Logs</a></li>
</ul>
</li>
<li><a href="#microk8s">Microk8s</a><ul>
<li><a href="#requisitos-b√°sicos-1">Requisitos b√°sicos</a></li>
<li><a href="#instala√ß√£o-do-microk8s-no-gnulinux">Instala√ß√£o do MicroK8s no GNU/Linux</a><ul>
<li><a href="#vers√µes-que-suportam-snap">Vers√µes que suportam Snap</a></li>
</ul>
</li>
<li><a href="#instala√ß√£o-no-windows">Instala√ß√£o no Windows</a><ul>
<li><a href="#instalando-o-chocolatey">Instalando o Chocolatey</a><ul>
<li><a href="#instalando-o-multipass">Instalando o Multipass</a></li>
</ul>
</li>
<li><a href="#utilizando-microk8s-com-multipass">Utilizando Microk8s com Multipass</a></li>
</ul>
</li>
<li><a href="#instalando-o-microk8s-no-mac">Instalando o Microk8s no Mac</a><ul>
<li><a href="#instalando-o-brew">Instalando o Brew</a></li>
<li><a href="#instalando-o-microk8s-via-brew">Instalando o Microk8s via Brew</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#kind">Kind</a><ul>
<li><a href="#instala√ß√£o-no-gnulinux">Instala√ß√£o no GNU/Linux</a></li>
<li><a href="#instala√ß√£o-no-macos">Instala√ß√£o no MacOS</a></li>
<li><a href="#instala√ß√£o-no-windows-1">Instala√ß√£o no Windows</a><ul>
<li><a href="#instala√ß√£o-no-windows-via-chocolatey">Instala√ß√£o no Windows via Chocolatey</a></li>
</ul>
</li>
<li><a href="#criando-um-cluster-com-o-kind">Criando um cluster com o Kind</a><ul>
<li><a href="#criando-um-cluster-com-m√∫ltiplos-n√≥s-locais-com-o-kind">Criando um cluster com m√∫ltiplos n√≥s locais com o Kind</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#k3s">k3s</a></li>
<li><a href="#instala√ß√£o-em-cluster-com-tr√™s-n√≥s">Instala√ß√£o em cluster com tr√™s n√≥s</a><ul>
<li><a href="#requisitos-b√°sicos-2">Requisitos b√°sicos</a></li>
<li><a href="#configura√ß√£o-de-m√≥dulos-de-kernel">Configura√ß√£o de m√≥dulos de kernel</a></li>
<li><a href="#atualiza√ß√£o-da-distribui√ß√£o">Atualiza√ß√£o da distribui√ß√£o</a></li>
<li><a href="#instala√ß√£o-do-docker-e-do-kubernetes">Instala√ß√£o do Docker e do Kubernetes</a></li>
<li><a href="#inicializa√ß√£o-do-cluster">Inicializa√ß√£o do cluster</a></li>
<li><a href="#configura√ß√£o-do-arquivo-de-contextos-do-kubectl">Configura√ß√£o do arquivo de contextos do kubectl</a></li>
<li><a href="#inserindo-os-n√≥s-workers-no-cluster">Inserindo os n√≥s workers no cluster</a><ul>
<li><a href="#m√∫ltiplas-interfaces">M√∫ltiplas Interfaces</a></li>
</ul>
</li>
<li><a href="#instala√ß√£o-do-pod-network">Instala√ß√£o do pod network</a></li>
<li><a href="#verificando-a-instala√ß√£o">Verificando a instala√ß√£o</a></li>
</ul>
</li>
<li><a href="#primeiros-passos-no-k8s">Primeiros passos no k8s</a><ul>
<li><a href="#exibindo-informa√ß√µes-detalhadas-sobre-os-n√≥s">Exibindo informa√ß√µes detalhadas sobre os n√≥s</a></li>
<li><a href="#exibindo-novamente-token-para-entrar-no-cluster">Exibindo novamente token para entrar no cluster</a></li>
<li><a href="#ativando-o-autocomplete">Ativando o autocomplete</a></li>
<li><a href="#verificando-os-namespaces-e-pods">Verificando os namespaces e pods</a></li>
<li><a href="#executando-nosso-primeiro-pod-no-k8s">Executando nosso primeiro pod no k8s</a></li>
<li><a href="#verificar-os-√∫ltimos-eventos-do-cluster">Verificar os √∫ltimos eventos do cluster</a></li>
<li><a href="#efetuar-o-dump-de-um-objeto-em-formato-yaml">Efetuar o dump de um objeto em formato YAML</a></li>
<li><a href="#socorro-s√£o-muitas-op√ß√µes">Socorro, s√£o muitas op√ß√µes!</a></li>
<li><a href="#expondo-o-pod">Expondo o pod</a></li>
<li><a href="#limpando-tudo-e-indo-para-casa">Limpando tudo e indo para casa</a></li>
</ul>
</li>
</ul>
<h1 id="o-qu√™-preciso-saber-antes-de-come√ßar">O qu√™ preciso saber antes de come√ßar?</h1>
<h2 id="qual-distro-gnulinux-devo-usar">Qual distro GNU/Linux devo usar?</h2>
<p>Devido ao fato de algumas ferramentas importantes, como o <code>systemd</code> e <code>journald</code>, terem se tornado padr√£o na maioria das principais distribui√ß√µes dispon√≠veis hoje, voc√™ n√£o deve encontrar problemas para seguir o treinamento, caso voc√™ opte por uma delas, como Ubuntu, Debian, CentOS e afins.</p>
<h2 id="alguns-sites-que-devemos-visitar">Alguns sites que devemos visitar</h2>
<ul>
<li><p><a href="https://kubernetes.io" target="_blank">https://kubernetes.io</a></p>
</li>
<li><p><a href="https://github.com/kubernetes/kubernetes/" target="_blank">https://github.com/kubernetes/kubernetes/</a></p>
</li>
<li><p><a href="https://github.com/kubernetes/kubernetes/issues" target="_blank">https://github.com/kubernetes/kubernetes/issues</a></p>
</li>
<li><p><a href="https://www.cncf.io/certification/cka/" target="_blank">https://www.cncf.io/certification/cka/</a></p>
</li>
<li><p><a href="https://www.cncf.io/certification/ckad/" target="_blank">https://www.cncf.io/certification/ckad/</a></p>
</li>
<li><p><a href="https://12factor.net/pt_br/" target="_blank">https://12factor.net/pt_br/</a></p>
</li>
</ul>
<h2 id="e-o-k8s">E o k8s?</h2>
<p><strong>Vers√£o resumida:</strong></p>
<p>O projeto Kubernetes foi desenvolvido pela Google, em meados de 2014, para atuar como um orquestrador de cont√™ineres para a empresa. O Kubernetes (k8s), cujo termo em Grego significa &quot;timoneiro&quot;, √© um projeto <em>opensource</em> que conta com <em>design</em> e desenvolvimento baseados no projeto Borg, que tamb√©m √© da Google <a href="https://kubernetes.io/blog/2015/04/borg-predecessor-to-kubernetes/" target="_blank">1</a>. Alguns outros produtos dispon√≠veis no mercado, tais como o Apache Mesos e o Cloud Foundry, tamb√©m surgiram a partir do projeto Borg.</p>
<p>Como Kubernetes √© uma palavra dif√≠cil de se pronunciar - e de se escrever - a comunidade simplesmente o apelidou de <strong>k8s</strong>, seguindo o padr√£o <a href="http://www.i18nguy.com/origini18n.html" target="_blank">i18n</a> (a letra &quot;k&quot; seguida por oito letras e o &quot;s&quot; no final), pronunciando-se simplesmente &quot;kates&quot;.</p>
<p><strong>Vers√£o longa:</strong></p>
<p>Praticamente todo software desenvolvido na Google √© executado em cont√™iner <a href="https://www.enterpriseai.news/2014/05/28/google-runs-software-containers/" target="_blank">2</a>. A Google j√° gerencia cont√™ineres em larga escala h√° mais de uma d√©cada, quando n√£o se falava tanto sobre isso. Para atender a demanda interna, alguns desenvolvedores do Google constru√≠ram tr√™s sistemas diferentes de gerenciamento de cont√™ineres: <strong>Borg</strong>, <strong>Omega</strong> e <strong>Kubernetes</strong>. Cada sistema teve o desenvolvimento bastante influenciado pelo antecessor, embora fosse desenvolvido por diferentes raz√µes.</p>
<p>O primeiro sistema de gerenciamento de cont√™ineres desenvolvido no Google foi o Borg, constru√≠do para gerenciar servi√ßos de longa dura√ß√£o e jobs em lote, que anteriormente eram tratados por dois sistemas:  <strong>Babysitter</strong> e <strong>Global Work Queue</strong>. O √∫ltimo influenciou fortemente a arquitetura do Borg, mas estava focado em execu√ß√£o de jobs em lote. O Borg continua sendo o principal sistema de gerenciamento de cont√™ineres dentro do Google por causa de sua escala, variedade de recursos e robustez extrema.</p>
<p>O segundo sistema foi o Omega, descendente do Borg. Ele foi impulsionado pelo desejo de melhorar a engenharia de software do ecossistema Borg. Esse sistema aplicou muitos dos padr√µes que tiveram sucesso no Borg, mas foi constru√≠do do zero para ter a arquitetura mais consistente. Muitas das inova√ß√µes do Omega foram posteriormente incorporadas ao Borg.</p>
<p>O terceiro sistema foi o Kubernetes. Concebido e desenvolvido em um mundo onde desenvolvedores externos estavam se interessando em cont√™ineres e o Google desenvolveu um neg√≥cio em amplo crescimento atualmente, que √© a venda de infraestrutura de nuvem p√∫blica.</p>
<p>O Kubernetes √© de c√≥digo aberto - em contraste com o Borg e o Omega que foram desenvolvidos como sistemas puramente internos do Google.
O Kubernetes foi desenvolvido com um foco mais forte na experi√™ncia de desenvolvedores que escrevem aplicativos que s√£o executados em um cluster: seu principal objetivo √© facilitar a implanta√ß√£o e o gerenciamento de sistemas distribu√≠dos, enquanto se beneficia do melhor uso de recursos de mem√≥ria e processamento que os cont√™ineres possibilitam.</p>
<p>Estas informa√ß√µes foram extra√≠das e adaptadas deste <a href="https://static.googleusercontent.com/media/research.google.com/pt-BR//pubs/archive/44843.pdf" target="_blank">artigo</a>, que descreve as li√ß√µes aprendidas com o desenvolvimento e opera√ß√£o desses sistemas.</p>
<h2 id="arquitetura-do-k8s">Arquitetura do k8s</h2>
<p>Assim como os demais orquestradores dispon√≠veis, o k8s tamb√©m segue um modelo <em>master/worker</em>, constituindo assim um <em>cluster</em>, onde para seu funcionamento devem existir no m√≠nimo tr√™s n√≥s: o n√≥ <em>master</em>, respons√°vel (por padr√£o) pelo gerenciamento do <em>cluster</em>, e os demais como <em>workers</em>, executores das aplica√ß√µes que queremos executar sobre esse <em>cluster</em>.</p>
<p>Embora exista a exig√™ncia de no m√≠nimo tr√™s n√≥s para a execu√ß√£o do k8s em um ambiente padr√£o, existem solu√ß√µes para se executar o k8s em um √∫nico n√≥. Alguns exemplos s√£o:</p>
<ul>
<li><p><a href="https://kind.sigs.k8s.io/docs/user/quick-start" target="_blank">Kind</a>: Uma ferramenta para execu√ß√£o de cont√™ineres Docker que simulam o funcionamento de um cluster Kubernetes. √â utilizado para fins did√°ticos, de desenvolvimento e testes. O <strong>Kind n√£o deve ser utilizado para produ√ß√£o</strong>;</p>
</li>
<li><p><a href="https://github.com/kubernetes/minikube" target="_blank">Minikube</a>: ferramenta para implementar um <em>cluster</em> Kubernetes localmente com apenas um n√≥. Muito utilizado para fins did√°ticos, de desenvolvimento e testes. O <strong>Minikube n√£o deve ser utilizado para produ√ß√£o</strong>;</p>
</li>
<li><p><a href="https://microk8s.io" target="_blank">MicroK8S</a>: Desenvolvido pela <a href="https://canonical.com" target="_blank">Canonical</a>, mesma empresa que desenvolve o <a href="https://ubuntu.com" target="_blank">Ubuntu</a>. Pode ser utilizado em diversas distribui√ß√µes e <strong>pode ser utilizada para ambientes de produ√ß√£o</strong>, em especial para <em>Edge Computing</em> e IoT (<em>Internet of things</em>);</p>
</li>
<li><p><a href="https://k3s.io" target="_blank">k3s</a>: Desenvolvido pela <a href="https://rancher.com" target="_blank">Rancher Labs</a>, √© um concorrente direto do MicroK8s, podendo ser executado inclusive em Raspberry Pi.</p>
</li>
</ul>
<p>A figura a seguir mostra a arquitetura interna de componentes do k8s.</p>
<table>
<thead>
<tr>
<th style="text-align:center"><img src="../../images/kubernetes_architecture.png" alt="Arquitetura Kubernetes"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><em>Arquitetura Kubernetes <a href="https://phoenixnap.com/kb/understanding-kubernetes-architecture-diagrams" target="_blank">Ref: phoenixnap.com KB article</a></em></td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>API Server</strong>: √â um dos principais componentes do k8s. Este componente fornece uma API que utiliza JSON sobre HTTP para comunica√ß√£o, onde para isto √© utilizado principalmente o utilit√°rio <code>kubectl</code>, por parte dos administradores, para a comunica√ß√£o com os demais n√≥s, como mostrado no gr√°fico. Estas comunica√ß√µes entre componentes s√£o estabelecidas atrav√©s de requisi√ß√µes <a href="https://restfulapi.net" target="_blank">REST</a>;</p>
</li>
<li><p><strong>etcd</strong>: O etcd √© um <em>datastore</em> chave-valor distribu√≠do que o k8s utiliza para armazenar as especifica√ß√µes, status e configura√ß√µes do <em>cluster</em>. Todos os dados armazenados dentro do etcd s√£o manipulados apenas atrav√©s da API. Por quest√µes de seguran√ßa, o etcd √© por padr√£o executado apenas em n√≥s classificados como <em>master</em> no <em>cluster</em> k8s, mas tamb√©m podem ser executados em <em>clusters</em> externos, espec√≠ficos para o etcd, por exemplo;</p>
</li>
<li><p><strong>Scheduler</strong>: O <em>scheduler</em> √© respons√°vel por selecionar o n√≥ que ir√° hospedar um determinado <em>pod</em> (a menor unidade de um <em>cluster</em> k8s - n√£o se preocupe sobre isso por enquanto, n√≥s falaremos mais sobre isso mais tarde) para ser executado. Esta sele√ß√£o √© feita baseando-se na quantidade de recursos dispon√≠veis em cada n√≥, como tamb√©m no estado de cada um dos n√≥s do <em>cluster</em>, garantindo assim que os recursos sejam bem distribu√≠dos. Al√©m disso, a sele√ß√£o dos n√≥s, na qual um ou mais pods ser√£o executados, tamb√©m pode levar em considera√ß√£o pol√≠ticas definidas pelo usu√°rio, tais como afinidade, localiza√ß√£o dos dados a serem lidos pelas aplica√ß√µes, etc;</p>
</li>
<li><p><strong>Controller Manager</strong>: √â o <em>controller manager</em> quem garante que o <em>cluster</em> esteja no √∫ltimo estado definido no etcd. Por exemplo: se no etcd um <em>deploy</em> est√° configurado para possuir dez r√©plicas de um <em>pod</em>, √© o <em>controller manager</em> quem ir√° verificar se o estado atual do <em>cluster</em> corresponde a este estado e, em caso negativo, procurar√° conciliar ambos;</p>
</li>
<li><p><strong>Kubelet</strong>: O <em>kubelet</em> pode ser visto como o agente do k8s que √© executado nos n√≥s workers. Em cada n√≥ worker dever√° existir um agente Kubelet em execu√ß√£o. O Kubelet √© respons√°vel por de fato gerenciar os <em>pods</em>, que foram direcionados pelo <em>controller</em> do <em>cluster</em>, dentro dos n√≥s, de forma que para isto o Kubelet pode iniciar, parar e manter os cont√™ineres e os pods em funcionamento de acordo com o instru√≠do pelo controlador do cluster;</p>
</li>
<li><p><strong>Kube-proxy</strong>: Age como um <em>proxy</em> e um <em>load balancer</em>. Este componente √© respons√°vel por efetuar roteamento de requisi√ß√µes para os <em>pods</em> corretos, como tamb√©m por cuidar da parte de rede do n√≥;</p>
</li>
<li><p><strong>Container Runtime</strong>: O <em>container runtime</em> √© o ambiente de execu√ß√£o de cont√™ineres necess√°rio para o funcionamento do k8s. Em 2016 suporte ao <a href="https://coreos.com/rkt/" target="_blank">rkt</a> foi adicionado, por√©m desde o in√≠cio o Docker j√° √© funcional e utilizado por padr√£o.</p>
</li>
</ul>
<h2 id="portas-que-devemos-nos-preocupar">Portas que devemos nos preocupar</h2>
<p><strong>MASTER</strong></p>
<table>
<thead>
<tr>
<th>Protocol</th>
<th>Direction</th>
<th>Port Range</th>
<th>Purpose</th>
<th>Used By</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>6443*</td>
<td>Kubernetes API server</td>
<td>All</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>2379-2380</td>
<td>etcd server client API</td>
<td>kube-apiserver, etcd</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10250</td>
<td>Kubelet API</td>
<td>Self, Control plane</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10251</td>
<td>kube-scheduler</td>
<td>Self</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10252</td>
<td>kube-controller-manager</td>
<td>Self</td>
</tr>
</tbody>
</table>
<ul>
<li>Toda porta marcada por * √© customiz√°vel, voc√™ precisa se certificar que a porta alterada tamb√©m esteja aberta.</li>
</ul>
<p><strong>WORKERS</strong></p>
<table>
<thead>
<tr>
<th>Protocol</th>
<th>Direction</th>
<th>Port Range</th>
<th>Purpose</th>
<th>Used By</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10250</td>
<td>Kubelet API</td>
<td>Self, Control plane</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>30000-32767</td>
<td>NodePort</td>
<td>Services All</td>
</tr>
</tbody>
</table>
<p>Caso voc√™ opte pelo <a href="https://weave.works" target="_blank">Weave</a> como <em>pod network</em>, devem ser liberadas tamb√©m as portas 6783 e 6784 TCP.</p>
<h2 id="t√°-mas-qual-tipo-de-aplica√ß√£o-eu-devo-rodar-sobre-o-k8s">T√°, mas qual tipo de aplica√ß√£o eu devo rodar sobre o k8s?</h2>
<p>O melhor <em>app</em> para executar em cont√™iner, principalmente no k8s, s√£o aplica√ß√µes que seguem o <a href="https://12factor.net/pt_br/" target="_blank">The Twelve-Factor App</a>.</p>
<h2 id="conceitos-chave-do-k8s">Conceitos-chave do k8s</h2>
<p>√â importante saber que a forma como o k8s gerencia os cont√™ineres √© ligeiramente diferente de outros orquestradores, como o Docker Swarm, sobretudo devido ao fato de que ele n√£o trata os cont√™ineres diretamente, mas sim atrav√©s de <em>pods</em>. Vamos conhecer alguns dos principais conceitos que envolvem o k8s a seguir:</p>
<ul>
<li><p><strong>Pod</strong>: √© o menor objeto do k8s. Como dito anteriormente, o k8s n√£o trabalha com os cont√™ineres diretamente, mas organiza-os dentro de <em>pods</em>, que s√£o abstra√ß√µes que dividem os mesmos recursos, como endere√ßos, volumes, ciclos de CPU e mem√≥ria. Um pod, embora n√£o seja comum, pode possuir v√°rios cont√™ineres;</p>
</li>
<li><p><strong>Controller</strong>: √© o objeto respons√°vel por interagir com o <em>API Server</em> e orquestrar algum outro objeto. Exemplos de objetos desta classe s√£o os <em>Deployments</em> e <em>Replication Controllers</em>;</p>
</li>
<li><p><strong>ReplicaSets</strong>: √© um objeto respons√°vel por garantir a quantidade de pods em execu√ß√£o no n√≥;</p>
</li>
<li><p><strong>Deployment</strong>: √â um dos principais <em>controllers</em> utilizados. O <em>Deployment</em>, em conjunto com o <em>ReplicaSet</em>, garante que determinado n√∫mero de r√©plicas de um pod esteja em execu√ß√£o nos n√≥s workers do cluster. Al√©m disso, o Deployment tamb√©m √© respons√°vel por gerenciar o ciclo de vida das aplica√ß√µes, onde caracter√≠sticas associadas a aplica√ß√£o, tais como imagem, porta, volumes e vari√°veis de ambiente, podem ser especificados em arquivos do tipo <em>yaml</em> ou <em>json</em> para posteriormente serem passados como par√¢metro para o <code>kubectl</code> executar o deployment. Esta a√ß√£o pode ser executada tanto para cria√ß√£o quanto para atualiza√ß√£o e remo√ß√£o do deployment;</p>
</li>
<li><p><strong>Jobs e CronJobs</strong>: s√£o objetos respons√°veis pelo gerenciamento de jobs isolados ou recorrentes.</p>
</li>
</ul>
<h1 id="aviso-sobre-os-comandos">Aviso sobre os comandos</h1>
<blockquote>
<p>Aten√ß√£o!!! Antes de cada comando √© apresentado o tipo prompt. Exemplos:</p>
</blockquote>
<pre><code>$ comando1
</code></pre><pre><code># comando2
</code></pre><blockquote>
<p>O prompt que inicia com o caractere &quot;$&quot;, indica que o comando deve ser executado com um usu√°rio comum do sistema operacional.</p>
<p>O prompt que inicia com o caractere &quot;#&quot;, indica que o comando deve ser executado com o usu√°rio <strong>root</strong>.</p>
<p>Voc√™ n√£o deve copiar/colar o prompt, apenas o comando. :-)</p>
</blockquote>
<h1 id="minikube">Minikube</h1>
<h2 id="requisitos-b√°sicos">Requisitos b√°sicos</h2>
<p>√â importante frisar que o Minikube deve ser instalado localmente, e n√£o em um <em>cloud provider</em>. Por isso, as especifica√ß√µes de <em>hardware</em> a seguir s√£o referentes √† m√°quina local.</p>
<ul>
<li>Processamento: 1 core;</li>
<li>Mem√≥ria: 2 GB;</li>
<li>HD: 20 GB.</li>
</ul>
<h2 id="instala√ß√£o-do-minikube-no-gnulinux">Instala√ß√£o do Minikube no GNU/Linux</h2>
<p>Antes de mais nada, verifique se a sua m√°quina suporta virtualiza√ß√£o. No GNU/Linux, isto pode ser realizado com:</p>
<pre><code>grep -E --color &apos;vmx|svm&apos; /proc/cpuinfo
</code></pre><p>Caso a sa√≠da do comando n√£o seja vazia, o resultado √© positivo.</p>
<p>Ap√≥s isso, vamos instalar o <code>kubectl</code> com os seguintes comandos.</p>
<pre><code>curl -LO https://storage.googleapis.com/kubernetes-release/release/`curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl

chmod +x ./kubectl

sudo mv ./kubectl /usr/local/bin/kubectl

kubectl version --client
</code></pre><p>H√° a possibilidade de n√£o utilizar um <em>hypervisor</em> para a instala√ß√£o do Minikube, executando-o ao inv√©s disso sobre o pr√≥prio host. Iremos utilizar o Oracle VirtualBox como <em>hypervisor</em>, que pode ser encontrado <a href="https://www.virtualbox.org" target="_blank">aqui</a>.</p>
<p>Efetue o download e a instala√ß√£o do <code>Minikube</code> utilizando os seguintes comandos.</p>
<pre><code>curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64

chmod +x ./minikube

sudo mv ./minikube /usr/local/bin/minikube

minikube version
</code></pre><h2 id="instala√ß√£o-do-minikube-no-macos">Instala√ß√£o do Minikube no MacOS</h2>
<p>No MacOS, o comando para verificar se o processador suporta virtualiza√ß√£o √©:</p>
<pre><code>sysctl -a | grep -E --color &apos;machdep.cpu.features|VMX&apos;
</code></pre><p>Se voc√™ visualizar <code>VMX</code> na sa√≠da, o resultado √© positivo.</p>
<p>O <code>kubectl</code> pode ser instalado no MacOS utilizando tanto o <a href="https://brew.sh" target="_blank">Homebrew</a>, quanto o m√©todo tradicional. Com o Homebrew j√° instalado, o kubectl pode ser instalado da seguinte forma.</p>
<pre><code>sudo brew install kubectl

kubectl version --client
</code></pre><p>Ou:</p>
<pre><code>sudo brew install kubectl-cli

kubectl version --client
</code></pre><p>J√° com o m√©todo tradicional, a instala√ß√£o pode ser realizada com os seguintes comandos.</p>
<pre><code>curl -LO &quot;https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/darwin/amd64/kubectl&quot;

chmod +x ./kubectl

sudo mv ./kubectl /usr/local/bin/kubectl

kubectl version --client
</code></pre><p>Por fim, efetue a instala√ß√£o do Minikube com um dos dois m√©todos a seguir, podendo optar-se pelo Homebrew ou pelo m√©todo tradicional.</p>
<pre><code>sudo brew install minikube

minikube version
</code></pre><p>Ou:</p>
<pre><code>curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-darwin-amd64

chmod +x ./minikube

sudo mv ./minikube /usr/local/bin/minikube

minikube version
</code></pre><h2 id="kubectl-alias-e-autocomplete">kubectl: alias e autocomplete</h2>
<p>Execute o seguinte comando para configurar o alias e autocomplete para o <code>kubectl</code>.</p>
<p>No Bash:</p>
<pre><code class="lang-bash"><span class="hljs-built_in">source</span> &lt;(kubectl completion bash) <span class="hljs-comment"># configura o autocomplete na sua sess√£o atual (antes, certifique-se de ter instalado o pacote bash-completion).</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;source &lt;(kubectl completion bash)&quot;</span> &gt;&gt; ~/.bashrc <span class="hljs-comment"># add autocomplete permanentemente ao seu shell.</span>
</code></pre>
<p>Crie o alias <code>k</code> para <code>kubectl</code>:</p>
<pre><code>alias k=kubectl

complete -F __start_kubectl k
</code></pre><p>No ZSH:</p>
<pre><code>source &lt;(kubectl completion zsh)

echo &quot;[[ $commands[kubectl] ]] &amp;&amp; source &lt;(kubectl completion zsh)&quot;
</code></pre><h2 id="instala√ß√£o-do-minikube-no-microsoft-windows">Instala√ß√£o do Minikube no Microsoft Windows</h2>
<p>No Microsoft Windows, voc√™ deve executar o comando <code>systeminfo</code> no prompt de comando ou no terminal. Caso o retorno deste comando seja semelhante com o descrito a seguir, ent√£o a virtualiza√ß√£o √© suportada.</p>
<pre><code>Hyper-V Requirements:     VM Monitor Mode Extensions: Yes
                          Virtualization Enabled In Firmware: Yes
                          Second Level Address Translation: Yes
                          Data Execution Prevention Available: Yes
</code></pre><p>Caso a linha a seguir tamb√©m esteja presente, n√£o √© necess√°ria a instala√ß√£o de um <em>hypervisor</em> como o Oracle VirtualBox:</p>
<pre><code>Hyper-V Requirements:     A hypervisor has been detected. Features required for Hyper-V will not be displayed.:     A hypervisor has been detected. Features required for Hyper-V will not be displayed.
</code></pre><p>A instala√ß√£o do <code>kubectl</code> pode ser realizada efetuando o download <a href="https://storage.googleapis.com/kubernetes-release/release/v1.19.1/bin/windows/amd64/kubectl.exe" target="_blank">neste link</a>. Feito isso, tamb√©m deve ser realizado download e a instala√ß√£o de um <em>hypervisor</em> (preferencialmente o <a href="https://www.virtualbox.org" target="_blank">Oracle VirtualBox</a>), caso no passo anterior n√£o tenha sido acusada a presen√ßa de um. Finalmente, efetue o download do instalador do Minikube <a href="https://github.com/kubernetes/minikube/releases/latest" target="_blank">aqui</a> e execute-o.</p>
<h2 id="iniciando-parando-e-excluindo-o-minikube">Iniciando, parando e excluindo o Minikube</h2>
<p>Quando operando em conjunto com um <em>hypervisor</em>, o Minikube cria uma m√°quina virtual, onde dentro dela estar√£o todos os componentes do k8s para execu√ß√£o. Para realizar a inicializa√ß√£o desse ambiente, antes de executar o minikube, precisamos setar o VirtualBox como padr√£o para subir este ambiente, para que isso aconte√ßa execute o comando:</p>
<pre><code>minikube config set driver virtualbox
</code></pre><p>Caso n√£o queria deixar o VirtualBox como padr√£o sempre que subir o ambiente novo, voc√™ deve digitar o comando <code>minikube start --driver=virtualbox</code>. Mas como j√° setamos o VirtualBox como padr√£o para subir o ambiente do minikube, basta executar:</p>
<pre><code>minikube start
</code></pre><p>Para criar um cluster com multi-node basta executar:</p>
<pre><code>minikube start --nodes 2 -p multinode-demo
</code></pre><p>Caso deseje parar o ambiente:</p>
<pre><code>minikube stop
</code></pre><p>Para excluir o ambiente:</p>
<pre><code>minikube delete
</code></pre><h2 id="certo-e-como-eu-sei-que-est√°-tudo-funcionando-como-deveria">Certo, e como eu sei que est√° tudo funcionando como deveria?</h2>
<p>Uma vez iniciado, voc√™ deve ter uma sa√≠da na tela similar √† seguinte:</p>
<pre><code>minikube start


üéâ  minikube 1.10.0 is available! Download it: https://github.com/kubernetes/minikube/releases/tag/v1.10.0
üí°  To disable this notice, run: &apos;minikube config set WantUpdateNotification false&apos;

üôÑ  minikube v1.9.2 on Darwin 10.11
‚ú®  Using the virtualbox driver based on existing profile
üëç  Starting control plane node m01 in cluster minikube
üîÑ  Restarting existing virtualbox VM for &quot;minikube&quot; ...
üê≥  Preparing Kubernetes v1.19.1 on Docker 19.03.8 ...
üåü  Enabling addons: default-storageclass, storage-provisioner
üèÑ  Done! kubectl is now configured to use &quot;minikube&quot;
</code></pre><p>Voc√™ pode ent√£o listar os n√≥s que fazem parte do seu <em>cluster</em> k8s com o seguinte comando:</p>
<pre><code>kubectl get nodes
</code></pre><p>A sa√≠da ser√° similar ao conte√∫do a seguir:</p>
<p>Para um node:</p>
<pre><code>kubectl get nodes

NAME       STATUS   ROLES    AGE   VERSION
minikube   Ready    master   8d    v1.19.1
</code></pre><p>Para multi-nodes:</p>
<pre><code>NAME                 STATUS    ROLES     AGE       VERSION
multinode-demo       Ready     master    5m        v1.19.1
multinode-demo-m02   Ready     &lt;none&gt;    4m        v1.19.1
</code></pre><p>Inicialmente, a inten√ß√£o do Minikube √© executar o k8s em apenas um n√≥, por√©m a partir da vers√£o 1.10.1 e poss√≠vel usar a fun√ß√£o de multi-node (Experimental).</p>
<p>Caso os comandos anteriores tenham sido executados sem erro, a instala√ß√£o do Minikube ter√° sido realizada com sucesso.</p>
<h2 id="descobrindo-o-endere√ßo-do-minikube">Descobrindo o endere√ßo do Minikube</h2>
<p>Como dito anteriormente, o Minikube ir√° criar uma m√°quina virtual, assim como o ambiente para a execu√ß√£o do k8s localmente. Ele tamb√©m ir√° configurar o <code>kubectl</code> para comunicar-se com o Minikube. Para saber qual √© o endere√ßo IP dessa m√°quina virtual, pode-se executar:</p>
<pre><code>minikube ip
</code></pre><p>O endere√ßo apresentado √© que deve ser utilizado para comunica√ß√£o com o k8s.</p>
<h2 id="acessando-a-m√°quina-do-minikube-via-ssh">Acessando a m√°quina do Minikube via SSH</h2>
<p>Para acessar a m√°quina virtual criada pelo Minikube, pode-se executar:</p>
<pre><code>minikube ssh
</code></pre><h2 id="dashboard">Dashboard</h2>
<p>O Minikube vem com um <em>dashboard</em> <em>web</em> interessante para que o usu√°rio iniciante observe como funcionam os <em>workloads</em> sobre o k8s. Para habilit√°-lo, o usu√°rio pode digitar:</p>
<pre><code>minikube dashboard
</code></pre><h2 id="logs">Logs</h2>
<p>Os <em>logs</em> do Minikube podem ser acessados atrav√©s do seguinte comando.</p>
<pre><code>minikube logs
</code></pre><h1 id="microk8s">Microk8s</h1>
<h2 id="requisitos-b√°sicos">Requisitos b√°sicos</h2>
<p>Existem alguns tipos de instala√ß√£o do Microk8s:</p>
<ul>
<li>GNU/Linux que suportam Snap;</li>
<li>Windows - 4GB RAM e 40GB HD Livre;</li>
<li>MacOS - Brew;</li>
<li>RaspBerry.</li>
</ul>
<h2 id="instala√ß√£o-do-microk8s-no-gnulinux">Instala√ß√£o do MicroK8s no GNU/Linux</h2>
<h3 id="vers√µes-que-suportam-snap">Vers√µes que suportam Snap</h3>
<p>BASH:</p>
<pre><code>sudo snap install microk8s --classic --channel=1.18/stable

sudo usermod -a -G microk8s $USER

sudo chown -f -R $USER ~/.kube

microk8s status --wait-ready

microk8s enable dns dashboard registry

alias kubectl=&apos;microk8s kubectl&apos;
</code></pre><h2 id="instala√ß√£o-no-windows">Instala√ß√£o no Windows</h2>
<p>Somente √© poss√≠vel em vers√µes do Windows Professional e Enterprise</p>
<p>Tamb√©m ser√° necess√°rio a instala√ß√£o por meio de um administrador de pacotes do Windows, o <a href="https://chocolatey.org/install" target="_blank">Chocolatey
</a></p>
<h3 id="instalando-o-chocolatey">Instalando o Chocolatey</h3>
<p>PowerShell Admin:</p>
<pre><code>Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString(&apos;https://chocolatey.org/install.ps1&apos;))
</code></pre><h4 id="instalando-o-multipass">Instalando o Multipass</h4>
<p>PowerShell Admin:</p>
<pre><code>choco install multipass
</code></pre><h3 id="utilizando-microk8s-com-multipass">Utilizando Microk8s com Multipass</h3>
<p>PowerShell Admin:</p>
<pre><code>multipass launch --name microk8s-vm --mem 4G --disk 40G

multipass exec microk8s-vm -- snap install microk8s --classic

multipass exec microk8s-vm -- iptables -P FORWARD ACCEPT

multipass list

Name                    State             IPv4             Release
microk8s-vm             RUNNING           10.72.145.216    Ubuntu 18.04 LTS

multipass shell microk8s-vm
</code></pre><p>Se quiser utilizar o Microk8s sem utilizar um shell criado pelo multipass utilize a seguinte express√£o.</p>
<p>PowerShell Admin:</p>
<pre><code>multipass exec microk8s-vm -- /snap/bin/microk8s.&lt;command&gt;
</code></pre><h2 id="instalando-o-microk8s-no-mac">Instalando o Microk8s no Mac</h2>
<p>Utilizando o gerenciador de pacotes do Mac <code>Brew</code>:</p>
<h3 id="instalando-o-brew">Instalando o Brew</h3>
<p>Se n√£o tiver o <code>brew</code> instalado em sua m√°quina siga os passos a seguir. Caso j√° o possua, v√° para o passo dois dessa se√ß√£o.</p>
<p>BASH:</p>
<pre><code>/bin/bash -c &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)&quot;
</code></pre><h3 id="instalando-o-microk8s-via-brew">Instalando o Microk8s via Brew</h3>
<p>BASH:</p>
<pre><code>sudo brew install ubuntu/microk8s/microk8s

sudo microk8s install

sudo microk8s kubectl get all --all-namespaces
</code></pre><p>Espere at√© que a configura√ß√£o do microk8s esteja pronta para ser utilizada.</p>
<p>BASH:</p>
<pre><code>microk8s status --wait-ready
</code></pre><p>Assim que o coment√°rio: <code>microk8s is running</code> for exibido, execute o seguinte comando.</p>
<p>BASH:</p>
<pre><code>microk8s kubectl &lt;command&gt;
</code></pre><h1 id="kind">Kind</h1>
<p>O Kind (Kubernetes in Docker) √© outra alternativa para executar o Kubernetes num ambiente local para testes e aprendizado, mas n√£o √© recomendado para uso em produ√ß√£o.</p>
<h2 id="instala√ß√£o-no-gnulinux">Instala√ß√£o no GNU/Linux</h2>
<p>Para fazer a instala√ß√£o no GNU/Linux, execute os seguintes comandos.</p>
<pre><code>curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.11.1/kind-linux-amd64

chmod +x ./kind

sudo mv ./kind /usr/local/bin/kind
</code></pre><h2 id="instala√ß√£o-no-macos">Instala√ß√£o no MacOS</h2>
<p>Para fazer a instala√ß√£o no MacOS, execute o seguinte comando.</p>
<pre><code>sudo brew install kind
</code></pre><p>ou</p>
<pre><code>curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.11.1/kind-darwin-amd64
chmod +x ./kind
mv ./kind /some-dir-in-your-PATH/kind
</code></pre><h2 id="instala√ß√£o-no-windows">Instala√ß√£o no Windows</h2>
<p>Para fazer a instala√ß√£o no Windows, execute os seguintes comandos.</p>
<pre><code>curl.exe -Lo kind-windows-amd64.exe https://kind.sigs.k8s.io/dl/v0.11.1/kind-windows-amd64

Move-Item .\kind-windows-amd64.exe c:\some-dir-in-your-PATH\kind.exe
</code></pre><h3 id="instala√ß√£o-no-windows-via-chocolatey">Instala√ß√£o no Windows via <a href="https://chocolatey.org/install" target="_blank">Chocolatey</a></h3>
<p>Execute o seguinte comando para instalar o Kind no Windows usando o Chocolatey.</p>
<pre><code>choco install kind
</code></pre><h2 id="criando-um-cluster-com-o-kind">Criando um cluster com o Kind</h2>
<p>Ap√≥s realizar a instala√ß√£o do Kind, vamos iniciar o nosso cluster.</p>
<pre><code>kind create cluster

Creating cluster &quot;kind&quot; ...
 ‚úì Ensuring node image (kindest/node:v1.21.1) üñº
 ‚úì Preparing nodes üì¶ üì¶ üì¶  
 ‚úì Writing configuration üìú 
 ‚úì Starting control-plane üïπÔ∏è 
 ‚úì Installing CNI üîå 
 ‚úì Installing StorageClass üíæ 
 ‚úì Joining worker nodes üöú 
Set kubectl context to &quot;kind-kind&quot;
You can now use your cluster with:

kubectl cluster-info --context kind-kind

Have a nice day! üëã
</code></pre><p>√â poss√≠vel criar mais de um cluster e personalizar o seu nome.</p>
<pre><code>kind create cluster --name giropops

Creating cluster &quot;giropops&quot; ...
 ‚úì Ensuring node image (kindest/node:v1.21.1) üñº
 ‚úì Preparing nodes üì¶ üì¶ üì¶  
 ‚úì Writing configuration üìú 
 ‚úì Starting control-plane üïπÔ∏è 
 ‚úì Installing CNI üîå 
 ‚úì Installing StorageClass üíæ 
 ‚úì Joining worker nodes üöú 
Set kubectl context to &quot;kind-giropops&quot;
You can now use your cluster with:

kubectl cluster-info --context kind-giropops

Have a nice day! üëã
</code></pre><p>Para visualizar os seus clusters utilizando o kind, execute o comando a seguir.</p>
<pre><code>kind get clusters

kind
giropops
</code></pre><p>Liste os nodes do cluster.</p>
<pre><code>kubectl get nodes

NAME                 STATUS   ROLES                  AGE     VERSION
kind-control-plane   Ready    control-plane,master   2m46s   v1.21.1
</code></pre><h3 id="criando-um-cluster-com-m√∫ltiplos-n√≥s-locais-com-o-kind">Criando um cluster com m√∫ltiplos n√≥s locais com o Kind</h3>
<p>√â poss√≠vel para essa aula incluir m√∫ltiplos n√≥s na estrutura do Kind, que foi mencionado anteriormente.</p>
<p>Execute o comando a seguir para selecionar e remover todos os clusters locais criados no Kind.</p>
<pre><code>kind delete clusters $(kind get clusters)
</code></pre><p>Crie um arquivo de configura√ß√£o para definir quantos e o tipo de n√≥s no cluster que voc√™ deseja. No exemplo a seguir, ser√° criado o arquivo de configura√ß√£o <code>kind-3nodes.yaml</code> para especificar um cluster com 1 n√≥ master (que executar√° o control plane) e 2 workers.</p>
<pre><code>cat &lt;&lt; EOF &gt; $HOME/kind-3nodes.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
  - role: worker
  - role: worker
EOF
</code></pre><p>Crie um cluster chamado <code>kind-multinodes</code> utilizando as especifica√ß√µes definidas no arquivo <code>kind-3nodes.yaml</code>.</p>
<pre><code>kind create cluster --name kind-multinodes --config $HOME/kind-3nodes.yaml

Creating cluster &quot;kind-multinodes&quot; ...
 ‚úì Ensuring node image (kindest/node:v1.21.1) üñº
 ‚úì Preparing nodes üì¶ üì¶ üì¶  
 ‚úì Writing configuration üìú 
 ‚úì Starting control-plane üïπÔ∏è 
 ‚úì Installing CNI üîå 
 ‚úì Installing StorageClass üíæ 
 ‚úì Joining worker nodes üöú 
Set kubectl context to &quot;kind-kind-multinodes&quot;
You can now use your cluster with:

kubectl cluster-info --context kind-kind-multinodes

Have a nice day! üëã
</code></pre><p>Valide a cria√ß√£o do cluster com o comando a seguir.</p>
<pre><code>kubectl get nodes

NAME                            STATUS   ROLES                  AGE     VERSION
kind-multinodes-control-plane   Ready    control-plane,master   2m46s   v1.21.1
kind-multinodes-worker          Ready    &lt;none&gt;                 2m16s   v1.21.1
kind-multinodes-worker2         Ready    &lt;none&gt;                 2m16s   v1.21.1
</code></pre><p>Mais informa√ß√µes sobre o Kind est√£o dispon√≠veis em: <a href="https://kind.sigs.k8s.io" target="_blank">https://kind.sigs.k8s.io</a></p>
<p>! Refer√™ncia: <a href="https://kubernetes.io/blog/2020/05/21/wsl-docker-kubernetes-on-the-windows-desktop/" target="_blank">kind multi-cluster</a></p>
<h1 id="k3s">k3s</h1>
<p>Vamos aprender como instalar o renomado k3s e adicionar nodes no seu cluster!</p>
<p>Nesse exemplo eu estou usando o Raspberry Pi 4, o <em>master</em> com 4GB de mem√≥ria RAM e 4 cores, e 2 workers com 2GB de mem√≥ria RAM e 4 cores.</p>
<p>Para instalar o k3s, basta executar o seguinte comando:</p>
<pre><code>curl -sfL https://get.k3s.io | sh -

[INFO]  Finding release for channel stable
[INFO]  Using v1.19.1+k3s1 as release
[INFO]  Downloading hash https://github.com/rancher/k3s/releases/download/v1.19.1+k3s1/sha256sum-arm.txt
[INFO]  Downloading binary https://github.com/rancher/k3s/releases/download/v1.19.1+k3s1/k3s-armhf
[INFO]  Verifying binary download
[INFO]  Installing k3s to /usr/local/bin/k3s
[INFO]  Creating /usr/local/bin/kubectl symlink to k3s
[INFO]  Creating /usr/local/bin/crictl symlink to k3s
[INFO]  Creating /usr/local/bin/ctr symlink to k3s
[INFO]  Creating killall script /usr/local/bin/k3s-killall.sh
[INFO]  Creating uninstall script /usr/local/bin/k3s-uninstall.sh
[INFO]  env: Creating environment file /etc/systemd/system/k3s.service.env
[INFO]  systemd: Creating service file /etc/systemd/system/k3s.service
[INFO]  systemd: Enabling k3s unit
Created symlink /etc/systemd/system/multi-user.target.wants/k3s.service ‚Üí /etc/systemd/system/k3s.service.
[INFO]  systemd: Starting k3s
</code></pre><p>Vamos ver se est√° tudo certo com o nosso node master.</p>
<pre><code>kubectl get nodes

NAME        STATUS   ROLES    AGE   VERSION
elliot-01   Ready    master   15s   v1.19.1+k3s1
</code></pre><p>Vamos ver os pods em execu√ß√£o:</p>
<pre><code>kubectl get pods

No resources found in default namespace.
</code></pre><p>Humm! Parece que n√£o temos nenhum, mas ser√° mesmo?</p>
<p>Vamos verificar novamente:</p>
<pre><code>kubectl get pods --all-namespaces

NAMESPACE     NAME                                     READY   STATUS      RESTARTS   AGE
kube-system   metrics-server-7566d596c8-rdn5f          1/1     Running     0          7m5s
kube-system   local-path-provisioner-6d59f47c7-mfp89   1/1     Running     0          7m5s
kube-system   coredns-8655855d6-ns4d4                  1/1     Running     0          7m5s
kube-system   helm-install-traefik-mqmp4               0/1     Completed   2          7m5s
kube-system   svclb-traefik-t49cs                      2/2     Running     0          6m11s
kube-system   traefik-758cd5fc85-jwvmc                 1/1     Running     0          6m12s
</code></pre><p>A√≠ est√£o os pods que est√£o executando por padr√£o, que o pr√≥prio k8s cria para executar seus pr√≥prios componentes internos. Mas temos muito mais coisas al√©m dos pods, vamos conferir tudo que est√° rodando no nosso lindo k3s:</p>
<pre><code>kubectl get all --all-namespaces

NAMESPACE     NAME                                         READY   STATUS      RESTARTS   AGE
kube-system   pod/metrics-server-7566d596c8-rdn5f          1/1     Running     0          11m
kube-system   pod/local-path-provisioner-6d59f47c7-mfp89   1/1     Running     0          11m
kube-system   pod/coredns-8655855d6-ns4d4                  1/1     Running     0          11m
kube-system   pod/helm-install-traefik-mqmp4               0/1     Completed   2          11m
kube-system   pod/svclb-traefik-t49cs                      2/2     Running     0          10m
kube-system   pod/traefik-758cd5fc85-jwvmc                 1/1     Running     0          10m

NAMESPACE     NAME                         TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)                      AGE
default       service/kubernetes           ClusterIP      10.43.0.1      &lt;none&gt;           443/TCP                      12m
kube-system   service/kube-dns             ClusterIP      10.43.0.10     &lt;none&gt;           53/UDP,53/TCP,9153/TCP       12m
kube-system   service/metrics-server       ClusterIP      10.43.181.42   &lt;none&gt;           443/TCP                      12m
kube-system   service/traefik-prometheus   ClusterIP      10.43.207.57   &lt;none&gt;           9100/TCP                     10m
kube-system   service/traefik              LoadBalancer   10.43.232.43   192.168.86.101   80:30953/TCP,443:31363/TCP   10m

NAMESPACE     NAME                           DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
kube-system   daemonset.apps/svclb-traefik   1         1         1       1            1           &lt;none&gt;          10m

NAMESPACE     NAME                                     READY   UP-TO-DATE   AVAILABLE   AGE
kube-system   deployment.apps/metrics-server           1/1     1            1           12m
kube-system   deployment.apps/local-path-provisioner   1/1     1            1           12m
kube-system   deployment.apps/coredns                  1/1     1            1           12m
kube-system   deployment.apps/traefik                  1/1     1            1           10m

NAMESPACE     NAME                                               DESIRED   CURRENT   READY   AGE
kube-system   replicaset.apps/metrics-server-7566d596c8          1         1         1       11m
kube-system   replicaset.apps/local-path-provisioner-6d59f47c7   1         1         1       11m
kube-system   replicaset.apps/coredns-8655855d6                  1         1         1       11m
kube-system   replicaset.apps/traefik-758cd5fc85                 1         1         1       10m

NAMESPACE     NAME                             COMPLETIONS   DURATION   AGE
kube-system   job.batch/helm-install-traefik   1/1           55s        11m
</code></pre><p>Muito legal, bacana e sensacional n√©?</p>
<p>Por√©m ainda temos apenas 1 node, queremos adicionar mais nodes para que tenhamos alta disponibilidade para nossas aplica√ß√µes.</p>
<p>Para fazer isso, primeiro vamos pegar o Token do nosso cluster pois iremos utiliz√°-lo para adicionar os outros nodes em nosso cluster.</p>
<pre><code># cat /var/lib/rancher/k3s/server/node-token

K10bded4a17f7674c322febfb517cde93afaa48c35b74528d9d2b7d20ec8e41a1ad::server:9d2c12e1112ecdc0d1f9a2fd0e2933fe
</code></pre><p>M√°gica, achamos nosso Token.</p>
<p>Agora finalmente bora adicionar mais nodes em nosso cluster.</p>
<p>Calma, antes pegue o IP de seu master:</p>
<pre><code>ifconfig

...
eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.86.101  netmask 255.255.255.0  broadcast 192.168.86.255
        inet6 fe80::f58b:e4b:c74e:cbd  prefixlen 64  scopeid 0x20&lt;link&gt;
        ether dc:a6:32:08:c5:6d  txqueuelen 1000  (Ethernet)
        RX packets 117526  bytes 161460044 (153.9 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 17418  bytes 1180417 (1.1 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
...
</code></pre><p>Legal! Agora que voc√™ j√° tem o Token e o IP da master, bora para o outro node.</p>
<p>J√° no outro node, n√≥s vamos executar o comando para que ele seja adicionado:</p>
<pre><code>curl -sfL https://get.k3s.io | K3S_URL=https://myserver:6443 K3S_TOKEN=XXX sh -
</code></pre><p>O comando ficar√° mais ou menos assim (lembre-se de trocar pelo seu IP e Token):</p>
<pre><code>curl -sfL https://get.k3s.io | K3S_URL=https://192.168.86.101:6443 K3S_TOKEN=K10bded4a17f7674c322febfb517cde93afaa48c35b74528d9d2b7d20ec8e41a1ad::server:9d2c12e1112ecdc0d1f9a2fd0e2933fe sh -

[INFO]  Finding release for channel stable
[INFO]  Using v1.19.1+k3s1 as release
[INFO]  Downloading hash https://github.com/rancher/k3s/releases/download/v1.19.1+k3s1/sha256sum-arm.txt
[INFO]  Downloading binary https://github.com/rancher/k3s/releases/download/v1.19.1+k3s1/k3s-armhf
[INFO]  Verifying binary download
[INFO]  Installing k3s to /usr/local/bin/k3s
[INFO]  Creating /usr/local/bin/kubectl symlink to k3s
[INFO]  Creating /usr/local/bin/crictl symlink to k3s
[INFO]  Creating /usr/local/bin/ctr symlink to k3s
[INFO]  Creating killall script /usr/local/bin/k3s-killall.sh
[INFO]  Creating uninstall script /usr/local/bin/k3s-agent-uninstall.sh
[INFO]  env: Creating environment file /etc/systemd/system/k3s-agent.service.env
[INFO]  systemd: Creating service file /etc/systemd/system/k3s-agent.service
[INFO]  systemd: Enabling k3s-agent unit
Created symlink /etc/systemd/system/multi-user.target.wants/k3s-agent.service ‚Üí /etc/systemd/system/k3s-agent.service.
[INFO]  systemd: Starting k3s-agent
</code></pre><p>Perfeito! Agora vamos ver se esse node est√° no nosso cluster mesmo:</p>
<pre><code>kubectl get nodes

NAME        STATUS   ROLES    AGE     VERSION
elliot-02   Ready    &lt;none&gt;   5m27s   v1.19.1+k3s1
elliot-01   Ready    master   34m     v1.19.1+k3s1
</code></pre><p>Olha ele ali, <code>elliot-02</code> j√° est√° lindo de bonito em nosso cluster, m√°gico n√£o?</p>
<p>Quer adicionar mais nodes? S√≥ copiar e colar aquele mesmo comando com o IP do master e o nosso Token no pr√≥ximo node.</p>
<pre><code>kubectl get nodes

NAME        STATUS   ROLES    AGE   VERSION
elliot-02   Ready    &lt;none&gt;   10m   v1.19.1+k3s1
elliot-01   Ready    master   39m   v1.19.1+k3s1
elliot-03   Ready    &lt;none&gt;   68s   v1.19.1+k3s1
</code></pre><p>Todos os elliots saud√°veis!!!</p>
<p>Pronto!!! Agora temos um cluster com 3 nodes trabalhando, e as possibilidades s√£o infinitas, divirta-se.</p>
<p>Para saber mais detalhes acesse as documenta√ß√µes oficiais do k3s:</p>
<ul>
<li><a href="https://k3s.io/" target="_blank">https://k3s.io/</a></li>
<li><a href="https://rancher.com/docs/k3s/latest/en/" target="_blank">https://rancher.com/docs/k3s/latest/en/</a></li>
<li><a href="https://github.com/rancher/k3s" target="_blank">https://github.com/rancher/k3s</a></li>
</ul>
<h1 id="instala√ß√£o-em-cluster-com-tr√™s-n√≥s">Instala√ß√£o em cluster com tr√™s n√≥s</h1>
<h2 id="requisitos-b√°sicos">Requisitos b√°sicos</h2>
<p>Como j√° dito anteriormente, o Minikube √© √≥timo para desenvolvedores, estudos e testes, mas n√£o tem como prop√≥sito a execu√ß√£o em ambiente de produ√ß√£o. Dito isso, a instala√ß√£o de um <em>cluster</em> k8s para o treinamento ir√° requerer pelo menos tr√™s m√°quinas, f√≠sicas ou virtuais, cada qual com no m√≠nimo a seguinte configura√ß√£o:</p>
<ul>
<li><p>Distribui√ß√£o: Debian, Ubuntu, CentOS, Red Hat, Fedora, SuSE;</p>
</li>
<li><p>Processamento: 2 <em>cores</em>;</p>
</li>
<li><p>Mem√≥ria: 2GB.</p>
</li>
</ul>
<h2 id="configura√ß√£o-de-m√≥dulos-de-kernel">Configura√ß√£o de m√≥dulos de kernel</h2>
<p>O k8s requer que certos m√≥dulos do kernel GNU/Linux estejam carregados para seu pleno funcionamento, e que esses m√≥dulos sejam carregados no momento da inicializa√ß√£o do computador. Para tanto, crie o arquivo <code>/etc/modules-load.d/k8s.conf</code> com o seguinte conte√∫do em todos os seus n√≥s.</p>
<pre><code>br_netfilter
ip_vs
ip_vs_rr
ip_vs_sh
ip_vs_wrr
nf_conntrack_ipv4
</code></pre><h2 id="atualiza√ß√£o-da-distribui√ß√£o">Atualiza√ß√£o da distribui√ß√£o</h2>
<p>Em distribui√ß√µes Debian e baseadas, como o Ubuntu, execute o comando a seguir, em cada um de seus n√≥s, para executar atualiza√ß√£o do sistema.</p>
<pre><code>sudo apt update

sudo apt upgrade -y
</code></pre><p>Em distribui√ß√µes Red Hat e baseadas, use o seguinte comando.</p>
<pre><code>sudo yum upgrade -y
</code></pre><h2 id="instala√ß√£o-do-docker-e-do-kubernetes">Instala√ß√£o do Docker e do Kubernetes</h2>
<p>A instala√ß√£o do Docker pode ser realizada com apenas um comando, que deve ser executado nos tr√™s n√≥s:</p>
<pre><code>curl -fsSL https://get.docker.com | bash
</code></pre><p>Para travar a uma vers√£o especifica do docker utilize o seguinte comando:</p>
<pre><code>export VERSION=&lt;vers√£o do docker&gt; &amp;&amp; curl -fsSL https://get.docker.com | bash
</code></pre><p>Embora a maneira anterior seja a mais f√°cil, n√£o permite o controle de op√ß√µes. Por esse motivo, a documenta√ß√£o do Kubernetes sugere uma instala√ß√£o mais controlada seguindo os passos dispon√≠veis em: <a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/" target="_blank">https://kubernetes.io/docs/setup/production-environment/container-runtimes/</a></p>
<p><strong>Caso escolha o m√©todo mais f√°cil</strong>, os pr√≥ximos comandos s√£o muito importantes, pois garantem que o driver <code>Cgroup</code> do Docker ser√° configurado para o <code>systemd</code>, que √© o gerenciador de servi√ßos padr√£o utilizado pelo Kubernetes.</p>
<p>Para a fam√≠lia Debian, execute o seguinte comando:</p>
<pre><code>cat &gt; /etc/docker/daemon.json &lt;&lt;EOF
{
  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],
  &quot;log-driver&quot;: &quot;json-file&quot;,
  &quot;log-opts&quot;: {
    &quot;max-size&quot;: &quot;100m&quot;
  },
  &quot;storage-driver&quot;: &quot;overlay2&quot;
}
EOF
</code></pre><p>Para a fam√≠lia Red Hat, execute o seguinte comando:</p>
<pre><code>cat &gt; /etc/docker/daemon.json &lt;&lt;EOF
{
  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],
  &quot;log-driver&quot;: &quot;json-file&quot;,
  &quot;log-opts&quot;: {
    &quot;max-size&quot;: &quot;100m&quot;
  },
  &quot;storage-driver&quot;: &quot;overlay2&quot;,
  &quot;storage-opts&quot;: [
    &quot;overlay2.override_kernel_check=true&quot;
  ]
}
EOF
</code></pre><p>Os passos a seguir s√£o iguais para ambas as fam√≠lias.</p>
<pre><code>sudo mkdir -p /etc/systemd/system/docker.service.d
</code></pre><p>Agora basta reiniciar o Docker.</p>
<pre><code>sudo systemctl daemon-reload
sudo systemctl restart docker
</code></pre><p>Para finalizar, verifique se o driver <code>Cgroup</code> foi corretamente definido.</p>
<pre><code>docker info | grep -i cgroup
</code></pre><p>Se a sa√≠da foi <code>Cgroup Driver: systemd</code>, tudo certo!</p>
<p>O pr√≥ximo passo √© efetuar a adi√ß√£o dos reposit√≥rios do k8s e efetuar a instala√ß√£o do <code>kubeadm</code>.</p>
<p>Em distribui√ß√µes Debian e baseadas, isso pode ser realizado com os comandos a seguir.</p>
<pre><code>sudo apt-get update &amp;&amp; sudo apt-get install -y apt-transport-https gnupg2

curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -

sudo echo &quot;deb http://apt.kubernetes.io/ kubernetes-xenial main&quot; &gt; /etc/apt/sources.list.d/kubernetes.list

sudo apt-get update

sudo apt-get install -y kubelet kubeadm kubectl
</code></pre><p>J√° em distribui√ß√µes Red Hat e baseadas, adicione o reposit√≥rio do k8s criando o arquivo <code>/etc/yum.repos.d/kubernetes.repo</code> com o conte√∫do a seguir:</p>
<pre><code>[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</code></pre><p>Os comandos a seguir desativam o <em>firewall</em>, instalam os pacotes do k8s e ativam o servi√ßo do mesmo.</p>
<pre><code>sudo setenforce 0

sudo systemctl stop firewalld

sudo systemctl disable firewalld

sudo yum install -y kubelet kubeadm kubectl

sudo systemctl enable docker &amp;&amp; sudo systemctl start docker

sudo systemctl enable kubelet &amp;&amp; sudo systemctl start kubelet
</code></pre><p>Ainda em distribui√ß√µes Red Hat e baseadas, √© necess√°rio a configura√ß√£o de alguns par√¢metros extras no kernel por meio do <strong>sysctl</strong>. Estes podem ser setados criando o arquivo <code>/etc/sysctl.d/k8s.conf</code> com o seguinte conte√∫do.</p>
<pre><code>net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
</code></pre><p>Em ambas distribui√ß√µes GNU/Linux tamb√©m √© necess√°rio desativar a mem√≥ria swap em todos os n√≥s com o comando a seguir.</p>
<pre><code>sudo swapoff -a
</code></pre><p>Al√©m de comentar a linha referente √† mesma no arquivo <code>/etc/fstab</code>.</p>
<p>Ap√≥s esses procedimentos, √© interessante a reinicializa√ß√£o de todos os n√≥s do <em>cluster</em>.</p>
<h2 id="inicializa√ß√£o-do-cluster">Inicializa√ß√£o do cluster</h2>
<p>Antes de inicializarmos o <em>cluster</em>, vamos efetuar o <em>download</em> das imagens que ser√£o utilizadas, executando o comando a seguir no n√≥ que ser√° o <em>master</em>.</p>
<pre><code>sudo kubeadm config images pull
</code></pre><p>Execute o comando a seguir tamb√©m apenas no n√≥ <em>master</em> para a inicializa√ß√£o do cluster. Caso tudo esteja bem, ser√° apresentada ao t√©rmino de sua execu√ß√£o o comando que deve ser executado nos demais n√≥s para ingressar no <em>cluster</em>.</p>
<pre><code>sudo kubeadm init
</code></pre><p>A op√ß√£o <em>--apiserver-advertise-address</em> informa qual o endere√ßo IP em que o servidor de API ir√° escutar. Caso este par√¢metro n√£o seja informado, a interface de rede padr√£o ser√° usada. Opcionalmente, voc√™ tamb√©m pode passar o cidr com a op√ß√£o <em>--pod-network-cidr</em>. O comando obedecer√° a seguinte sintaxe:</p>
<pre><code>kubeadm init --apiserver-advertise-address 192.168.99.2 --pod-network-cidr 192.168.99.0/24
</code></pre><p>A sa√≠da do comando ser√° algo similar ao mostrado a seguir.</p>
<pre><code>    [WARNING SystemVerification]: docker version is greater than the most recently validated version. Docker version: 18.05.0-ce. Max validated version: 17.03
...
To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config
...
kubeadm join --token 39c341.a3bc3c4dd49758d5 IP_DO_MASTER:6443 --discovery-token-ca-cert-hash sha256:37092
...
</code></pre><p>Caso o servidor possua mais de uma interface de rede, voc√™ pode verificar se o IP interno do n√≥ do seu cluster corresponde ao IP da interface esperada com o seguinte comando:</p>
<pre><code>kubectl describe node elliot-1 | grep InternalIP
</code></pre><p>A sa√≠da ser√° algo similar a seguir:</p>
<pre><code>InternalIP:  192.168.99.2
</code></pre><p>Caso o Ip n√£o corresponda ao da interface de rede escolhida, voc√™ pode ir at√© o arquivo localizado em <em>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</em> com o editor da sua prefer√™ncia, procurar por <em>KUBELET_CONFIG_ARGS</em> e adicionar no final a instru√ß√£o --node-ip=<ip da sua prefer√™ncia>. O trecho alterado ser√° semelhante abaixo:</ip></p>
<pre><code>Environment=&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml --node-ip=192.168.99.2&quot;
</code></pre><p>Salve o arquivo e execute os comandos abaixo para reiniciar a configura√ß√£o e consequentemente o kubelet.</p>
<pre><code>sudo systemctl daemon-reload
sudo systemctl restart kubelet
</code></pre><h2 id="configura√ß√£o-do-arquivo-de-contextos-do-kubectl">Configura√ß√£o do arquivo de contextos do kubectl</h2>
<p>Como dito anteriormente e de forma similar ao Docker Swarm, o pr√≥prio kubeadm j√° mostrar√° os comandos necess√°rios para a configura√ß√£o do <code>kubectl</code>, para que assim possa ser estabelecida comunica√ß√£o com o cluster k8s. Para tanto, execute os seguintes comandos.</p>
<pre><code>mkdir -p $HOME/.kube

cp -i /etc/kubernetes/admin.conf $HOME/.kube/config

sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre><h2 id="inserindo-os-n√≥s-workers-no-cluster">Inserindo os n√≥s workers no cluster</h2>
<p>Para inserir os n√≥s <em>workers</em> no <em>cluster</em>, basta executar a linha que come√ßa com <code>kubeadm join</code> nos mesmos.</p>
<h3 id="m√∫ltiplas-interfaces">M√∫ltiplas Interfaces</h3>
<p>Caso algum dos n√≥s que ser√° utilizado tenha mais de uma interface de rede, verifique se ele consegue alcan√ßar o <code>service</code> do <code>Kubernetes</code> atrav√©s da rota padr√£o.</p>
<p>Para verificar, ser√° necess√°rio pegar o IP interno do <code>service</code> Kubernetes atrav√©s do comando <code>kubectl get services kubernetes</code>. Ap√≥s obter o IP, basta ir no n√≥ que ser√° ingressado no cluster e rodar o comando <code>curl -k https://SERVICE</code> alterando o <code>SERVICE</code> para o IP do <code>service</code>. Exemplo: <code>curl -k https://10.96.0.1</code>.</p>
<p>Caso a sa√≠da seja algo parecido com o exemplo a seguir, a conex√£o est√° acontecendo normalmente.</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;kind&quot;</span>: <span class="hljs-string">&quot;Status&quot;</span>,
  <span class="hljs-string">&quot;apiVersion&quot;</span>: <span class="hljs-string">&quot;v1&quot;</span>,
  <span class="hljs-string">&quot;metadata&quot;</span>: {

  },
  <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;Failure&quot;</span>,
  <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;forbidden: User \&quot;system:anonymous\&quot; cannot get path \&quot;/\&quot;&quot;</span>,
  <span class="hljs-string">&quot;reason&quot;</span>: <span class="hljs-string">&quot;Forbidden&quot;</span>,
  <span class="hljs-string">&quot;details&quot;</span>: {

  },
  <span class="hljs-string">&quot;code&quot;</span>: <span class="hljs-number">403</span>
}
</code></pre>
<p>Caso a sa√≠da n√£o seja parecido com o exemplo, ser√° necess√°rio adicionar uma rota com o seguinte comando.</p>
<pre><code class="lang-shell">ip route add REDE_DO_SERVICE/16 dev INTERFACE
</code></pre>
<p>Substitua a <code>REDE_DO SERVICE</code> com a rede do <code>service</code> (geralmente √© um IP finalizando com 0).</p>
<p>Exemplo: Se o IP for <code>10.96.0.1</code> a rede √© <code>10.96.0.0</code>) e a <code>INTERFACE</code> com a interface do n√≥ que tem acesso ao <code>master</code> do cluster.</p>
<p>Exemplo de comando para adicionar uma rota:</p>
<pre><code>sudo ip route add 10.96.0.0/16 dev eth1
</code></pre><p>Adicione a rota nas configura√ß√µes de rede para que seja criada durante o boot.</p>
<h2 id="instala√ß√£o-do-pod-network">Instala√ß√£o do pod network</h2>
<p>Para os usu√°rios do Docker Swarm, h√° uma diferen√ßa entre os dois orquestradores: o k8s por padr√£o n√£o fornece uma solu√ß√£o de <em>networking</em> <em>out-of-the-box</em>. Para que isso ocorra, deve ser instalada uma solu√ß√£o de <em>pod networking</em> como <em>add-on</em>. Existem diversas op√ß√µes dispon√≠veis, cada qual com funcionalidades diferentes, tais como: <a href="https://github.com/coreos/flannel" target="_blank">Flannel</a>, <a href="http://docs.projectcalico.org/" target="_blank">Calico</a>, <a href="http://romana.io" target="_blank">Romana</a>, <a href="https://www.weave.works/products/weave-net/" target="_blank">Weave-net</a>, entre outros.</p>
<p>Mais informa√ß√µes sobre <em>pod networking</em> ser√£o abordados nos demais dias do treinamento.</p>
<p>Caso voc√™ ainda n√£o tenha reiniciado os n√≥s que comp√µem o seu <em>cluster</em>, voc√™ pode carregar os m√≥dulos do kernel necess√°rios com o seguinte comando.</p>
<pre><code>sudo modprobe br_netfilter ip_vs_rr ip_vs_wrr ip_vs_sh nf_conntrack_ipv4 ip_vs
</code></pre><p>No curso, n√≥s iremos utilizar o <strong>Weave-net</strong>, que pode ser instalado com o comando a seguir.</p>
<pre><code>kubectl apply -f &quot;https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d &apos;\n&apos;)&quot;
</code></pre><p>Para verificar se o <em>pod network</em> foi criado com sucesso, execute o seguinte comando.</p>
<pre><code>kubectl get pods -n kube-system
</code></pre><p>O resultado deve ser semelhante ao mostrado a seguir.</p>
<pre><code>NAME                                READY   STATUS    RESTARTS   AGE
coredns-66bff467f8-pfm2c            1/1     Running   0          8d
coredns-66bff467f8-s8pk4            1/1     Running   0          8d
etcd-docker-01                      1/1     Running   0          8d
kube-apiserver-docker-01            1/1     Running   0          8d
kube-controller-manager-docker-01   1/1     Running   0          8d
kube-proxy-mdcgf                    1/1     Running   0          8d
kube-proxy-q9cvf                    1/1     Running   0          8d
kube-proxy-vf8mq                    1/1     Running   0          8d
kube-scheduler-docker-01            1/1     Running   0          8d
weave-net-7dhpf                     2/2     Running   0          8d
weave-net-fvttp                     2/2     Running   0          8d
weave-net-xl7km                     2/2     Running   0          8d
</code></pre><p>Pode-se observar que h√° tr√™s cont√™ineres do Weave-net em execu√ß√£o provendo a <em>pod network</em> para o nosso <em>cluster</em>.</p>
<h2 id="verificando-a-instala√ß√£o">Verificando a instala√ß√£o</h2>
<p>Para verificar se a instala√ß√£o est√° funcionando, e se os n√≥s est√£o se comunicando, voc√™ pode executar o comando <code>kubectl get nodes</code> no n√≥ master, que deve lhe retornar algo como o conte√∫do a seguir.</p>
<pre><code>NAME        STATUS   ROLES    AGE   VERSION
elliot-01   Ready    master   8d    v1.19.1
elliot-02   Ready    &lt;none&gt;   8d    v1.19.1
elliot-03   Ready    &lt;none&gt;   8d    v1.19.1
</code></pre><h1 id="primeiros-passos-no-k8s">Primeiros passos no k8s</h1>
<h2 id="exibindo-informa√ß√µes-detalhadas-sobre-os-n√≥s">Exibindo informa√ß√µes detalhadas sobre os n√≥s</h2>
<pre><code>kubectl describe node [nome_do_no]
</code></pre><p>Exemplo:</p>
<pre><code>kubectl describe node elliot-02

Name:               elliot-02
Roles:              &lt;none&gt;
Labels:             beta.kubernetes.io/arch=amd64
                    beta.kubernetes.io/os=linux
                    kubernetes.io/arch=amd64
                    kubernetes.io/hostname=elliot-02
                    kubernetes.io/os=linux
Annotations:        kubeadm.alpha.kubernetes.io/cri-socket: /var/run/dockershim.sock
                    node.alpha.kubernetes.io/ttl: 0
                    volumes.kubernetes.io/controller-managed-attach-detach: true
</code></pre><h2 id="exibindo-novamente-token-para-entrar-no-cluster">Exibindo novamente token para entrar no cluster</h2>
<p>Para visualizar novamente o <em>token</em> para inser√ß√£o de novos n√≥s, execute o seguinte comando.</p>
<pre><code>sudo kubeadm token create --print-join-command
</code></pre><h2 id="ativando-o-autocomplete">Ativando o autocomplete</h2>
<p>Em distribui√ß√µes Debian e baseadas, certifique-se que o pacote <code>bash-completion</code> esteja instalado. Instale-o com o comando a seguir.</p>
<pre><code>sudo apt install -y bash-completion
</code></pre><p>Em sistemas Red Hat e baseados, execute:</p>
<pre><code>sudo yum install -y bash-completion
</code></pre><p>Feito isso, execute o seguinte comando.</p>
<pre><code>kubectl completion bash &gt; /etc/bash_completion.d/kubectl
</code></pre><p>Efetue <em>logoff</em> e <em>login</em> para carregar o <em>autocomplete</em>. Caso n√£o deseje, execute:</p>
<pre><code>source &lt;(kubectl completion bash)
</code></pre><h2 id="verificando-os-namespaces-e-pods">Verificando os namespaces e pods</h2>
<p>O k8s organiza tudo dentro de <em>namespaces</em>. Por meio deles, podem ser realizadas limita√ß√µes de seguran√ßa e de recursos dentro do <em>cluster</em>, tais como <em>pods</em>, <em>replication controllers</em> e diversos outros. Para visualizar os <em>namespaces</em> dispon√≠veis no <em>cluster</em>, digite:</p>
<pre><code>kubectl get namespaces

NAME              STATUS   AGE
default           Active   8d
kube-node-lease   Active   8d
kube-public       Active   8d
kube-system       Active   8d
</code></pre><p>Vamos listar os <em>pods</em> do <em>namespace</em> <strong>kube-system</strong> utilizando o comando a seguir.</p>
<pre><code>kubectl get pod -n kube-system

NAME                                READY   STATUS    RESTARTS   AGE
coredns-66bff467f8-pfm2c            1/1     Running   0          8d
coredns-66bff467f8-s8pk4            1/1     Running   0          8d
etcd-docker-01                      1/1     Running   0          8d
kube-apiserver-docker-01            1/1     Running   0          8d
kube-controller-manager-docker-01   1/1     Running   0          8d
kube-proxy-mdcgf                    1/1     Running   0          8d
kube-proxy-q9cvf                    1/1     Running   0          8d
kube-proxy-vf8mq                    1/1     Running   0          8d
kube-scheduler-docker-01            1/1     Running   0          8d
weave-net-7dhpf                     2/2     Running   0          8d
weave-net-fvttp                     2/2     Running   0          8d
weave-net-xl7km                     2/2     Running   0          8d
</code></pre><p>Ser√° que h√° algum <em>pod</em> escondido em algum <em>namespace</em>? √â poss√≠vel listar todos os <em>pods</em> de todos os <em>namespaces</em> com o comando a seguir.</p>
<pre><code>kubectl get pods --all-namespaces
</code></pre><p>H√° a possibilidade ainda, de utilizar o comando com a op√ß√£o <code>-o wide</code>, que disponibiliza maiores informa√ß√µes sobre o recurso, inclusive em qual n√≥ o <em>pod</em> est√° sendo executado. Exemplo:</p>
<pre><code>kubectl get pods --all-namespaces -o wide

NAMESPACE     NAME                                READY   STATUS    RESTARTS   AGE   IP             NODE        NOMINATED NODE   READINESS GATES
default       nginx                               1/1     Running   0          24m   10.44.0.1      docker-02   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-66bff467f8-pfm2c            1/1     Running   0          8d    10.32.0.3      docker-01   &lt;none&gt;           &lt;none&gt;
kube-system   coredns-66bff467f8-s8pk4            1/1     Running   0          8d    10.32.0.2      docker-01   &lt;none&gt;           &lt;none&gt;
kube-system   etcd-docker-01                      1/1     Running   0          8d    172.16.83.14   docker-01   &lt;none&gt;           &lt;none&gt;
kube-system   kube-apiserver-docker-01            1/1     Running   0          8d    172.16.83.14   docker-01   &lt;none&gt;           &lt;none&gt;
kube-system   kube-controller-manager-docker-01   1/1     Running   0          8d    172.16.83.14   docker-01   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-mdcgf                    1/1     Running   0          8d    172.16.83.14   docker-01   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-q9cvf                    1/1     Running   0          8d    172.16.83.12   docker-03   &lt;none&gt;           &lt;none&gt;
kube-system   kube-proxy-vf8mq                    1/1     Running   0          8d    172.16.83.13   docker-02   &lt;none&gt;           &lt;none&gt;
kube-system   kube-scheduler-docker-01            1/1     Running   0          8d    172.16.83.14   docker-01   &lt;none&gt;           &lt;none&gt;
kube-system   weave-net-7dhpf                     2/2     Running   0          8d    172.16.83.12   docker-03   &lt;none&gt;           &lt;none&gt;
kube-system   weave-net-fvttp                     2/2     Running   0          8d    172.16.83.13   docker-02   &lt;none&gt;           &lt;none&gt;
kube-system   weave-net-xl7km                     2/2     Running   0          8d    172.16.83.14   docker-01   &lt;none&gt;           &lt;none&gt;
</code></pre><h2 id="executando-nosso-primeiro-pod-no-k8s">Executando nosso primeiro pod no k8s</h2>
<p>Iremos iniciar o nosso primeiro <em>pod</em> no k8s. Para isso, executaremos o comando a seguir.</p>
<pre><code>kubectl run nginx --image nginx

pod/nginx created
</code></pre><p>Listando os <em>pods</em> com <code>kubectl get pods</code>, obteremos a seguinte sa√≠da.</p>
<pre><code>NAME    READY   STATUS    RESTARTS   AGE
nginx   1/1     Running   0          66s
</code></pre><p>Vamos olhar agora a descri√ß√£o desse objeto dentro do <em>cluster</em>.</p>
<pre><code>kubectl describe pod nginx

Name:         nginx
Namespace:    default
Priority:     0
Node:         docker-02/172.16.83.13
Start Time:   Tue, 12 May 2020 02:29:38 -0300
Labels:       run=nginx
Annotations:  &lt;none&gt;
Status:       Running
IP:           10.44.0.1
IPs:
  IP:  10.44.0.1
Containers:
  nginx:
    Container ID:   docker://2719e2bc023944ee8f34db538094c96b24764a637574c703e232908b46b12a9f
    Image:          nginx
    Image ID:       docker-pullable://nginx@sha256:86ae264c3f4acb99b2dee4d0098c40cb8c46dcf9e1148f05d3a51c4df6758c12
    Port:           &lt;none&gt;
    Host Port:      &lt;none&gt;
    State:          Running
      Started:      Tue, 12 May 2020 02:29:42 -0300
</code></pre><h2 id="verificar-os-√∫ltimos-eventos-do-cluster">Verificar os √∫ltimos eventos do cluster</h2>
<p>Voc√™ pode verificar quais s√£o os √∫ltimos eventos do <em>cluster</em> com o comando <code>kubectl get events</code>. Ser√£o mostrados eventos como: o <em>download</em> de imagens do Docker Hub (ou de outro <em>registry</em> configurado), a cria√ß√£o/remo√ß√£o de <em>pods</em>, etc.</p>
<p>A sa√≠da a seguir mostra o resultado da cria√ß√£o do nosso cont√™iner com Nginx.</p>
<pre><code>LAST SEEN   TYPE     REASON      OBJECT      MESSAGE
5m34s       Normal   Scheduled   pod/nginx   Successfully assigned default/nginx to docker-02
5m33s       Normal   Pulling     pod/nginx   Pulling image &quot;nginx&quot;
5m31s       Normal   Pulled      pod/nginx   Successfully pulled image &quot;nginx&quot;
5m30s       Normal   Created     pod/nginx   Created container nginx
5m30s       Normal   Started     pod/nginx   Started container nginx
</code></pre><p>No resultado do comando anterior √© poss√≠vel observar que a execu√ß√£o do nginx ocorreu no <em>namespace</em> default e que a imagem <strong>nginx</strong> n√£o existia no reposit√≥rio local e, sendo assim, teve de ser feito download da imagem.</p>
<h2 id="efetuar-o-dump-de-um-objeto-em-formato-yaml">Efetuar o dump de um objeto em formato YAML</h2>
<p>Assim como quando se est√° trabalhando com <em>stacks</em> no Docker Swarm, normalmente recursos no k8s s√£o declarados em arquivos <strong>YAML</strong> ou <strong>JSON</strong> e depois manipulados atrav√©s do <code>kubectl</code>.</p>
<p>Para nos poupar o trabalho de escrever o arquivo inteiro, pode-se utilizar como <em>template</em> o <em>dump</em> de um objeto j√° existente no k8s, como mostrado a seguir.</p>
<pre><code>kubectl get pod nginx -o yaml &gt; meu-primeiro.yaml
</code></pre><p>Ser√° criado um novo arquivo chamado <code>meu-primeiro.yaml</code>, resultante do redirecionamento da sa√≠da do comando <code>kubectl get pod nginx -o yaml</code>.</p>
<p>Abrindo o arquivo com <code>vim meu-primeiro.yaml</code> (voc√™ pode utilizar o editor que voc√™ preferir), teremos o seguinte conte√∫do.</p>
<pre><code class="lang-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">creationTimestamp:</span> <span class="hljs-string">&quot;2020-05-12T05:29:38Z&quot;</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">run:</span> <span class="hljs-string">nginx</span>
  <span class="hljs-attr">managedFields:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
    <span class="hljs-attr">fieldsType:</span> <span class="hljs-string">FieldsV1</span>
    <span class="hljs-attr">fieldsV1:</span>
      <span class="hljs-attr">f:metadata:</span>
        <span class="hljs-attr">f:labels:</span>
          <span class="hljs-string">.:</span> {}
          <span class="hljs-attr">f:run:</span> {}
      <span class="hljs-attr">f:spec:</span>
        <span class="hljs-attr">f:containers:</span>
          <span class="hljs-string">k:{&quot;name&quot;:&quot;nginx&quot;}:</span>
            <span class="hljs-string">.:</span> {}
            <span class="hljs-attr">f:image:</span> {}
            <span class="hljs-attr">f:imagePullPolicy:</span> {}
            <span class="hljs-attr">f:name:</span> {}
            <span class="hljs-attr">f:resources:</span> {}
            <span class="hljs-attr">f:terminationMessagePath:</span> {}
            <span class="hljs-attr">f:terminationMessagePolicy:</span> {}
        <span class="hljs-attr">f:dnsPolicy:</span> {}
        <span class="hljs-attr">f:enableServiceLinks:</span> {}
        <span class="hljs-attr">f:restartPolicy:</span> {}
        <span class="hljs-attr">f:schedulerName:</span> {}
        <span class="hljs-attr">f:securityContext:</span> {}
        <span class="hljs-attr">f:terminationGracePeriodSeconds:</span> {}
    <span class="hljs-attr">manager:</span> <span class="hljs-string">kubectl</span>
    <span class="hljs-attr">operation:</span> <span class="hljs-string">Update</span>
    <span class="hljs-attr">time:</span> <span class="hljs-string">&quot;2020-05-12T05:29:38Z&quot;</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
    <span class="hljs-attr">fieldsType:</span> <span class="hljs-string">FieldsV1</span>
    <span class="hljs-attr">fieldsV1:</span>
      <span class="hljs-attr">f:status:</span>
        <span class="hljs-attr">f:conditions:</span>
          <span class="hljs-string">k:{&quot;type&quot;:&quot;ContainersReady&quot;}:</span>
            <span class="hljs-string">.:</span> {}
            <span class="hljs-attr">f:lastProbeTime:</span> {}
            <span class="hljs-attr">f:lastTransitionTime:</span> {}
            <span class="hljs-attr">f:status:</span> {}
            <span class="hljs-attr">f:type:</span> {}
          <span class="hljs-string">k:{&quot;type&quot;:&quot;Initialized&quot;}:</span>
            <span class="hljs-string">.:</span> {}
            <span class="hljs-attr">f:lastProbeTime:</span> {}
            <span class="hljs-attr">f:lastTransitionTime:</span> {}
            <span class="hljs-attr">f:status:</span> {}
            <span class="hljs-attr">f:type:</span> {}
          <span class="hljs-string">k:{&quot;type&quot;:&quot;Ready&quot;}:</span>
            <span class="hljs-string">.:</span> {}
            <span class="hljs-attr">f:lastProbeTime:</span> {}
            <span class="hljs-attr">f:lastTransitionTime:</span> {}
            <span class="hljs-attr">f:status:</span> {}
            <span class="hljs-attr">f:type:</span> {}
        <span class="hljs-attr">f:containerStatuses:</span> {}
        <span class="hljs-attr">f:hostIP:</span> {}
        <span class="hljs-attr">f:phase:</span> {}
        <span class="hljs-attr">f:podIP:</span> {}
        <span class="hljs-attr">f:podIPs:</span>
          <span class="hljs-string">.:</span> {}
          <span class="hljs-string">k:{&quot;ip&quot;:&quot;10.44.0.1&quot;}:</span>
            <span class="hljs-string">.:</span> {}
            <span class="hljs-attr">f:ip:</span> {}
        <span class="hljs-attr">f:startTime:</span> {}
    <span class="hljs-attr">manager:</span> <span class="hljs-string">kubelet</span>
    <span class="hljs-attr">operation:</span> <span class="hljs-string">Update</span>
    <span class="hljs-attr">time:</span> <span class="hljs-string">&quot;2020-05-12T05:29:43Z&quot;</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>
  <span class="hljs-attr">resourceVersion:</span> <span class="hljs-string">&quot;1673991&quot;</span>
  <span class="hljs-attr">selfLink:</span> <span class="hljs-string">/api/v1/namespaces/default/pods/nginx</span>
  <span class="hljs-attr">uid:</span> <span class="hljs-string">36506f7b-1f3b-4ee8-b063-de3e6d31bea9</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">containers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span>
    <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">Always</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
    <span class="hljs-attr">resources:</span> {}
    <span class="hljs-attr">terminationMessagePath:</span> <span class="hljs-string">/dev/termination-log</span>
    <span class="hljs-attr">terminationMessagePolicy:</span> <span class="hljs-string">File</span>
    <span class="hljs-attr">volumeMounts:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/run/secrets/kubernetes.io/serviceaccount</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">default-token-nkz89</span>
      <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">ClusterFirst</span>
  <span class="hljs-attr">enableServiceLinks:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">nodeName:</span> <span class="hljs-string">docker-02</span>
  <span class="hljs-attr">priority:</span> <span class="hljs-number">0</span>
  <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Always</span>
  <span class="hljs-attr">schedulerName:</span> <span class="hljs-string">default-scheduler</span>
  <span class="hljs-attr">securityContext:</span> {}
  <span class="hljs-attr">serviceAccount:</span> <span class="hljs-string">default</span>
  <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">default</span>
  <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">30</span>
  <span class="hljs-attr">tolerations:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">NoExecute</span>
    <span class="hljs-attr">key:</span> <span class="hljs-string">node.kubernetes.io/not-ready</span>
    <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span>
    <span class="hljs-attr">tolerationSeconds:</span> <span class="hljs-number">300</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">NoExecute</span>
    <span class="hljs-attr">key:</span> <span class="hljs-string">node.kubernetes.io/unreachable</span>
    <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span>
    <span class="hljs-attr">tolerationSeconds:</span> <span class="hljs-number">300</span>
  <span class="hljs-attr">volumes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">default-token-nkz89</span>
    <span class="hljs-attr">secret:</span>
      <span class="hljs-attr">defaultMode:</span> <span class="hljs-number">420</span>
      <span class="hljs-attr">secretName:</span> <span class="hljs-string">default-token-nkz89</span>
<span class="hljs-attr">status:</span>
  <span class="hljs-attr">conditions:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">lastProbeTime:</span> <span class="hljs-literal">null</span>
    <span class="hljs-attr">lastTransitionTime:</span> <span class="hljs-string">&quot;2020-05-12T05:29:38Z&quot;</span>
    <span class="hljs-attr">status:</span> <span class="hljs-string">&quot;True&quot;</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">Initialized</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">lastProbeTime:</span> <span class="hljs-literal">null</span>
    <span class="hljs-attr">lastTransitionTime:</span> <span class="hljs-string">&quot;2020-05-12T05:29:43Z&quot;</span>
    <span class="hljs-attr">status:</span> <span class="hljs-string">&quot;True&quot;</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">Ready</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">lastProbeTime:</span> <span class="hljs-literal">null</span>
    <span class="hljs-attr">lastTransitionTime:</span> <span class="hljs-string">&quot;2020-05-12T05:29:43Z&quot;</span>
    <span class="hljs-attr">status:</span> <span class="hljs-string">&quot;True&quot;</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">ContainersReady</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">lastProbeTime:</span> <span class="hljs-literal">null</span>
    <span class="hljs-attr">lastTransitionTime:</span> <span class="hljs-string">&quot;2020-05-12T05:29:38Z&quot;</span>
    <span class="hljs-attr">status:</span> <span class="hljs-string">&quot;True&quot;</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">PodScheduled</span>
  <span class="hljs-attr">containerStatuses:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">containerID:</span> <span class="hljs-string">docker://2719e2bc023944ee8f34db538094c96b24764a637574c703e232908b46b12a9f</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:latest</span>
    <span class="hljs-attr">imageID:</span> <span class="hljs-string">docker-pullable://nginx@sha256:86ae264c3f4acb99b2dee4d0098c40cb8c46dcf9e1148f05d3a51c4df6758c12</span>
    <span class="hljs-attr">lastState:</span> {}
    <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
    <span class="hljs-attr">ready:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">restartCount:</span> <span class="hljs-number">0</span>
    <span class="hljs-attr">started:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">state:</span>
      <span class="hljs-attr">running:</span>
        <span class="hljs-attr">startedAt:</span> <span class="hljs-string">&quot;2020-05-12T05:29:42Z&quot;</span>
  <span class="hljs-attr">hostIP:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.83</span><span class="hljs-number">.13</span>
  <span class="hljs-attr">phase:</span> <span class="hljs-string">Running</span>
  <span class="hljs-attr">podIP:</span> <span class="hljs-number">10.44</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
  <span class="hljs-attr">podIPs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">ip:</span> <span class="hljs-number">10.44</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
  <span class="hljs-attr">qosClass:</span> <span class="hljs-string">BestEffort</span>
  <span class="hljs-attr">startTime:</span> <span class="hljs-string">&quot;2020-05-12T05:29:38Z&quot;</span>
</code></pre>
<p>Observando o arquivo anterior, notamos que este reflete o <strong>estado</strong> do <em>pod</em>. N√≥s desejamos utilizar tal arquivo apenas como um modelo, e sendo assim, podemos apagar as entradas que armazenam dados de estado desse <em>pod</em>, como <em>status</em> e todas as demais configura√ß√µes que s√£o espec√≠ficas dele. O arquivo final ficar√° com o conte√∫do semelhante a este:</p>
<pre><code class="lang-yaml">  <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
  <span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span>
  <span class="hljs-attr">metadata:</span>
    <span class="hljs-attr">creationTimestamp:</span> <span class="hljs-literal">null</span>
    <span class="hljs-attr">labels:</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">nginx</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
  <span class="hljs-attr">spec:</span>
    <span class="hljs-attr">containers:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
      <span class="hljs-attr">resources:</span> {}
    <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">ClusterFirst</span>
    <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Always</span>
  <span class="hljs-attr">status:</span> {}
</code></pre>
<p>Vamos agora remover o nosso <em>pod</em> com o seguinte comando.</p>
<pre><code>kubectl delete pod nginx
</code></pre><p>A sa√≠da deve ser algo como:</p>
<pre><code>pod &quot;nginx&quot; deleted
</code></pre><p>Vamos recri√°-lo, agora a partir do nosso arquivo YAML.</p>
<pre><code>kubectl create -f meu-primeiro.yaml

pod/nginx created
</code></pre><p>Observe que n√£o foi necess√°rio informar ao <code>kubectl</code> qual tipo de recurso seria criado, pois isso j√° est√° contido dentro do arquivo.</p>
<p>Listando os <em>pods</em> dispon√≠veis com o seguinte comando.</p>
<pre><code>kubectl get pods
</code></pre><p>Deve-se obter uma sa√≠da similar √† esta:</p>
<pre><code>NAME    READY   STATUS    RESTARTS   AGE
nginx   1/1     Running   0          109s
</code></pre><p>Uma outra forma de criar um arquivo de <em>template</em> √© atrav√©s da op√ß√£o <code>--dry-run</code> do <code>kubectl</code>, com o funcionamento ligeiramente diferente dependendo do tipo de recurso que ser√° criado. Exemplos:</p>
<p>Para a cria√ß√£o do template de um <em>pod</em>:</p>
<pre><code>kubectl run meu-nginx --image nginx --dry-run=client -o yaml &gt; pod-template.yaml
</code></pre><p>Para a cria√ß√£o do <em>template</em> de um <em>deployment</em>:</p>
<pre><code>kubectl create deployment meu-nginx --image=nginx --dry-run=client -o yaml &gt; deployment-template.yaml
</code></pre><p>A vantagem deste m√©todo √© que n√£o h√° a necessidade de limpar o arquivo, al√©m de serem apresentadas apenas as op√ß√µes necess√°rias do recurso.</p>
<h2 id="socorro-s√£o-muitas-op√ß√µes">Socorro, s√£o muitas op√ß√µes!</h2>
<p>Calma, n√≥s sabemos. Mas o <code>kubectl</code> pode lhe auxiliar um pouco em rela√ß√£o a isso. Ele cont√©m a op√ß√£o <code>explain</code>, que voc√™ pode utilizar caso precise de ajuda com alguma op√ß√£o em espec√≠fico dos arquivos de recurso. A seguir alguns exemplos de sintaxe.</p>
<pre><code>kubectl explain [recurso]

kubectl explain [recurso.caminho.para.spec]

kubectl explain [recurso.caminho.para.spec] --recursive
</code></pre><p>Exemplos:</p>
<pre><code>kubectl explain deployment

kubectl explain pod --recursive

kubectl explain deployment.spec.template.spec
</code></pre><h2 id="expondo-o-pod">Expondo o pod</h2>
<p>Dispositivos fora do <em>cluster</em>, por padr√£o, n√£o conseguem acessar os <em>pods</em> criados, como √© comum em outros sistemas de cont√™ineres. Para expor um <em>pod</em>, execute o comando a seguir.</p>
<pre><code>kubectl expose pod nginx
</code></pre><p>Ser√° apresentada a seguinte mensagem de erro:</p>
<pre><code>error: couldn&apos;t find port via --port flag or introspection
See &apos;kubectl expose -h&apos; for help and examples
</code></pre><p>O erro ocorre devido ao fato do k8s n√£o saber qual √© a porta de destino do cont√™iner que deve ser exposta (no caso, a 80/TCP). Para configur√°-la, vamos primeiramente remover o nosso <em>pod</em> antigo:</p>
<pre><code>kubectl delete -f meu-primeiro.yaml
</code></pre><p>Abra agora o arquivo <code>meu-primeiro.yaml</code> e adicione o bloco a seguir.</p>
<pre><code class="lang-yaml"><span class="hljs-string">...</span>
<span class="hljs-attr">spec:</span>
       <span class="hljs-attr">containers:</span>
       <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span>
         <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">Always</span>
         <span class="hljs-attr">ports:</span>
         <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span>
         <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
         <span class="hljs-attr">resources:</span> {}
<span class="hljs-string">...</span>
</code></pre>
<blockquote>
<p>Aten√ß√£o!!! Arquivos YAML utilizam para sua tabula√ß√£o dois espa√ßos e n√£o <em>tab</em>.</p>
</blockquote>
<p>Feita a modifica√ß√£o no arquivo, salve-o e crie novamente o <em>pod</em> com o comando a seguir.</p>
<pre><code>kubectl create -f meu-primeiro.yaml

pod/nginx created
</code></pre><p>Liste o pod.</p>
<pre><code>kubectl get pod nginx

NAME    READY   STATUS    RESTARTS   AGE
nginx   1/1     Running   0          32s
</code></pre><p>O comando a seguir cria um objeto do k8s chamado de <em>Service</em>, que √© utilizado justamente para expor <em>pods</em> para acesso externo.</p>
<pre><code>kubectl expose pod nginx
</code></pre><p>Podemos listar todos os <em>services</em> com o comando a seguir.</p>
<pre><code>kubectl get services

NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   8d
nginx        ClusterIP   10.105.41.192   &lt;none&gt;        80/TCP    2m30s
</code></pre><p>Como √© poss√≠vel observar, h√° dois <em>services</em> no nosso <em>cluster</em>: o primeiro √© para uso do pr√≥prio k8s, enquanto o segundo foi o qu√™ acabamos de criar. Utilizando o <code>curl</code> contra o endere√ßo IP mostrado na coluna <em>CLUSTER-IP</em>, deve nos ser apresentada a tela principal do Nginx.</p>
<pre><code>curl 10.105.41.192

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><p>Este <em>pod</em> est√° dispon√≠vel para acesso a partir de qualquer n√≥ do <em>cluster</em>.</p>
<h2 id="limpando-tudo-e-indo-para-casa">Limpando tudo e indo para casa</h2>
<p>Para mostrar todos os recursos rec√©m criados, pode-se utilizar uma das seguintes op√ß√µes a seguir.</p>
<pre><code>kubectl get all

kubectl get pod,service

kubectl get pod,svc
</code></pre><p>Note que o k8s nos disponibiliza algumas abrevia√ß√µes de seus recursos. Com o tempo voc√™ ir√° se familiar com elas. Para apagar os recursos criados, voc√™ pode executar os seguintes comandos.</p>
<pre><code>kubectl delete -f meu-primeiro.yaml

kubectl delete service nginx
</code></pre><p>Liste novamente os recursos para ver se os mesmos ainda est√£o presentes.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../" class="navigation navigation-prev " aria-label="Previous page: Introdu√ß√£o">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../day_two/descomplicando_kubernetes.html" class="navigation navigation-next " aria-label="Next page: Descomplicando Kubernetes dia 2">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Descomplicando Kubernetes dia 1","level":"2.1","depth":1,"next":{"title":"Descomplicando Kubernetes dia 2","level":"2.2","depth":1,"path":"day_two/descomplicando_kubernetes.md","ref":"day_two/descomplicando_kubernetes.md","articles":[]},"previous":{"title":"Introdu√ß√£o","level":"1.1","depth":1,"path":"README.md","ref":"README.md","articles":[]},"dir":"ltr"},"config":{"plugins":[],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"language":"pt","gitbook":"*"},"file":{"path":"day_one/descomplicando_kubernetes.md","mtime":"2021-09-11T11:01:15.252Z","type":"markdown"},"gitbook":{"version":"3.6.20","time":"2021-09-11T11:01:28.533Z"},"basePath":"..","book":{"language":"pt"}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

